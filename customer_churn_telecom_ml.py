#!/usr/bin/env python
# coding: utf-8

# ## –í–≤–µ–¥–µ–Ω–∏–µ
# ### –ê–Ω–Ω–æ—Ç–∞—Ü–∏—è
# > **–ü—Ä–æ–µ–∫—Ç:** –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ ML-–º–æ–¥–µ–ª–µ–π –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞ –æ—Ç—Ç–æ–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤\
# > 
# > **–ó–∞–∫–∞–∑—á–∏–∫:** –¢–µ–ª–µ–∫–æ–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è (–æ–ø–µ—Ä–∞—Ç–æ—Ä —Å–æ—Ç–æ–≤–æ–π —Å–≤—è–∑–∏)\
# > 
# > **–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:**
# > 
# > –¢–µ–ª–µ–∫–æ–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è —Ö–æ—á–µ—Ç –±–æ—Ä–æ—Ç—å—Å—è —Å –æ—Ç—Ç–æ–∫–æ–º –∫–ª–∏–µ–Ω—Ç–æ–≤.
# > 
# > –î–ª—è —ç—Ç–æ–≥–æ –µ–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –Ω–∞—á–Ω—É—Ç –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥—ã –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –≤—Å–µ–º, –∫—Ç–æ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç —É—Å–ª—É–≥ —Å–≤—è–∑–∏. –ß—Ç–æ–±—ã –∑–∞—Ä–∞–Ω–µ–µ –Ω–∞—Ö–æ–¥–∏—Ç—å —Ç–∞–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω—É–∂–Ω–∞ –º–æ–¥–µ–ª—å, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞—Ç—å, —Ä–∞–∑–æ—Ä–≤—ë—Ç –ª–∏ –∞–±–æ–Ω–µ–Ω—Ç –¥–æ–≥–æ–≤–æ—Ä
# >
# > –ö–æ–º–∞–Ω–¥–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —Å–æ–±—Ä–∞–ª–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –∫–ª–∏–µ–Ω—Ç–∞—Ö, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏—Ö —Ç–∞—Ä–∏—Ñ–∞—Ö –∏ —É—Å–ª—É–≥–∞—Ö
# > 
# > _‚ùóÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–≥–æ–≤–æ—Ä–∞—Ö –∞–∫—Ç—É–∞–ª—å–Ω–∞ –Ω–∞ 1 —Ñ–µ–≤—Ä–∞–ª—è 2020 –≥–æ–¥–∞_
# 
# 
# ### –¶–µ–ª—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
# > –¶–µ–ª—å—é –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —è–≤–ª—è–µ—Ç—Å—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞ –æ—Ç—Ç–æ–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ 
# 
# ### –û–±—ä–µ–∫—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
# > –î–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–µ–π –±—ã–ª–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –Ω–∞–±–æ—Ä—ã –¥–∞–Ω–Ω—ã—Ö, —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:
# > ```python
# > 'contract_new.csv'    # –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–≥–æ–≤–æ—Ä–µ
# > 'personal_new.csv'    # –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
# > 'internet_new.csv'    # –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—É—Å–ª—É–≥–∞—Ö
# > 'phone_new.csv'       # –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å–ª—É–≥–∞—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–∏–∏
# > ```
# 
# ### –†–µ–∑—É–ª—å—Ç–∞—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
# > - –í—ã–±—Ä–∞–Ω–∞ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∞ –ª—É—á—à–∞—è ML-–º–æ–¥–µ–ª—å —Å–æ–≥–ª–∞—Å–Ω–æ —Ü–µ–ª—è–º –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
# > - –ü–æ –∏—Ç–æ–≥–∞–º –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ –¥–∞–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞ –∏ —Å–¥–µ–ª–∞–Ω—ã –≤—ã–≤–æ–¥—ã
# 
# ### –•–æ–¥ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
# **–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –º–æ–∂–Ω–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ 3 –±–ª–æ–∫–∞:**
# >
# > **I. EDA**
# >
# > –ò–∑–Ω–∞—á–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∏—Å—Ç–æ—Ç–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç—Å—É—Å—Ç–≤—É–µ—Ç. –ü–æ—ç—Ç–æ–º—É, –≤–Ω–∞—á–∞–ª–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –∏–∑—É—á–µ–Ω—ã –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫, –Ω–µ–¥–æ—á–µ—Ç–æ–≤, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –¥–∞–Ω–Ω—ã—Ö, –∏—Ö –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –∏ –Ω–∞–ª–∏—á–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤. –î–∞–ª–µ–µ –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö. –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ–¥–µ–Ω –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö
# >
# > **II –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ ML-–º–æ–¥–µ–ª–µ–π**
# >
# > –ù–∞ –æ—Å–Ω–æ–≤–µ —É–∂–µ –∏—Å–ª–µ–¥–æ–≤–∞–Ω–Ω—ã—Ö –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –±—É–¥—É—Ç –æ–±—É—á–µ–Ω—ã –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω—ã –Ω–µ—Å–∫–æ–ª—å–∫–æ ML-–º–æ–¥–µ–ª–µ–π –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –±—É–¥–µ—Ç –≤—ã–±—Ä–∞–Ω–∞ –ª—É—á—à–∞—è –∏–∑ –Ω–∏—Ö, –ø—Ä–æ–≤–µ–¥–µ–Ω –µ–µ –∞–Ω–∞–ª–∏–∑ –∏ —Å–¥–µ–ª–∞–Ω—ã –≤—ã–≤–æ–¥—ã
# >
# > **III –ó–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–µ –≤—ã–≤–æ–¥—ã**
# > 
# > –í –∫–æ–Ω—Ü–µ –≤—Å–µ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –±—É–¥—É—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã –∑–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–µ –≤—ã–≤–æ–¥—ã –∏ –¥–∞–Ω—ã –æ–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
# 
# **–°–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –±—É–¥–µ—Ç —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 6 —ç—Ç–∞–ø–æ–≤:**
# > 1. –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –∏–∑—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–∑
# > 2. –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
# > 3. –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö
# > 4. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –æ–±—É—á–µ–Ω–∏–µ ML-–º–æ–¥–µ–ª–µ–π
# > 5. –ê–Ω–∞–ª–∏–∑ –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏
# > 6. –ó–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–µ –≤—ã–≤–æ–¥—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

# ## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
# ---

# ### –ò–º–ø–æ—Ä—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫
# ---

# In[1]:


# –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
import os
import warnings

from io import StringIO
from IPython.display import display, Markdown
from joblib import Memory

# –°—Ç–æ—Ä–æ–Ω–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
import matplotlib.pyplot as plt
import numpy as np
import optuna
import pandas as pd
import phik
import seaborn as sns
import shap

from lightgbm import (
    LGBMClassifier
)
from imblearn.pipeline import Pipeline as ImpPipeline
from optuna.distributions import (
    CategoricalDistribution,
    IntDistribution,
    FloatDistribution
)
from optuna.integration import (
    OptunaSearchCV
)

from sklearn.compose import (
    ColumnTransformer
)
from sklearn.dummy import (
    DummyClassifier
)
from sklearn.ensemble import (
    RandomForestClassifier,
    AdaBoostClassifier
)
from sklearn.impute import (
    SimpleImputer
)
from sklearn.inspection import (
    permutation_importance
)
from sklearn.linear_model import (
    RidgeClassifier,
    PassiveAggressiveClassifier
)
from sklearn.metrics import (
    roc_auc_score,
    accuracy_score,
    confusion_matrix,
    roc_curve,
    RocCurveDisplay,
    auc
)
from sklearn.model_selection import (
    StratifiedKFold,
    train_test_split
)
from sklearn.neighbors import (
    KNeighborsClassifier
)
from sklearn.preprocessing import (
    StandardScaler,
    MinMaxScaler, 
    RobustScaler,
    PowerTransformer,
    QuantileTransformer,
    LabelEncoder,
    OneHotEncoder,
    OrdinalEncoder,
)
from sklearn.svm import SVC
from sklearn.tree import (
    DecisionTreeClassifier
)
from tqdm.auto import tqdm
from tqdm_joblib import tqdm_joblib

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç–∏–ª–µ–π
sns.set_style('darkgrid')

# –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
warnings.filterwarnings('ignore')
tqdm.pandas()


# ### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ—Å—Ç–∞–Ω—Ç
# ---

# In[2]:


# –®–†–ò–§–¢–´
# –†–∞–∑–º–µ—Ä—ã —à—Ä–∏—Ñ—Ç–æ–≤
FONT_SIZE_LABEL = 12
FONT_SIZE_TICK = 10
FONT_SIZE_LEGEND = 10

# –í–µ—Å–∞ —à—Ä–∏—Ñ—Ç–æ–≤
FONT_WEIGHT_NORMAL = 'normal'

FONT_TITLE_KWARGS = dict(
    y=1.05,
    fontsize=18,
    fontweight='black'
)

FONT_SUBTITLE_KWARGS = dict(
    y=1.05,
    fontsize=16,
    fontweight='semibold'
)

# –¶–í–ï–¢–ê
# –ü–∞–ª–∏—Ç—Ä—ã —Ü–≤–µ—Ç–æ–≤
PALETTE_CAT = 'coolwarm_r'
PALETTE_CAT_ALT = 'coolwarm'
PALETTE_NUMERIC = 'Purples'
PALETTE_NUMERIC_ALT = 'Purples_r'
PALETTE_GREY = 'Greys'

# –û–¥–∏–Ω–æ—á–Ω—ã–µ —Ü–≤–µ—Ç–∞
COLORS_SINGLE_MAIN = sns.color_palette(PALETTE_NUMERIC, n_colors=6)
COLOR_SINGLE_BASIC = COLORS_SINGLE_MAIN[2]

COLORS_SINGLE_GREY = sns.color_palette(PALETTE_GREY, n_colors=6)
COLOR_SINGLE_GREY_BASIC = COLORS_SINGLE_GREY[2]

# –ê–ª—å—Ñ–∞ –∫–∞–Ω–∞–ª
ALPHA_FILL = 0.6

# –†–ê–ó–ú–ï–†–´ –§–ò–ì–£–†
FIGSIZE_SINGLE = (18, 6)
FIGSIZE_DOUBLE = (16, 8)
FIGSIZE_GRID = (18, 6)
FIGSIZE_SQUARED = (18, 16)
FIGSIZE_SQUARED_SMALL = (12, 12)

# –ü–ê–†–ê–ú–ï–¢–†–´ –ì–†–ê–§–ò–ö–û–í
BINS = 30

# –ü–û–î–ü–ò–°–ò –û–°–ï–ô
# –û—Ç—Å—Ç—É–ø—ã
TITLE_Y = 1.05

# –ö–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏
X_CAPTION_CAT = '–ó–Ω–∞—á–µ–Ω–∏–µ'
Y_CAPTION_CAT = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'

# –ß–∏—Å–ª–æ–≤—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏
X_CAPTION_NUMERIC = '–ó–Ω–∞—á–µ–Ω–∏–µ'
Y_CAPTION_NUMERIC_FREQ = '–ß–∞—Å—Ç–æ—Ç–∞'
Y_CAPTION_NUMERIC_DIST = '–ü–ª–æ—Ç–Ω–æ—Å—Ç—å'

# –í–∞–∂–Ω–æ—Å—Ç—å
X_CAPTION_IMP = '–í–∞–∂–Ω–æ—Å—Ç—å'
Y_CAPTION_IMP = '–ü—Ä–∏–∑–Ω–∞–∫'

# –ü–ê–†–ê–ú–ï–¢–†–´ –ú–û–î–ï–õ–ï–ô
RANDOM_STATE = 20226
TEST_SIZE = .25
TARGET_FEATURE = 'user_left'


# ## –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –∏–∑—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
# ___

# ### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –∏–∑—É—á–µ–Ω–∏—è
# ___

# In[3]:


def load_data(filename, path, alt_path=None, **params):
    local_file = os.path.join(path, filename)
    
    if os.path.exists(path):
        source = local_file
        source_type = '–õ–æ–∫–∞–ª—å–Ω–æ'
    else:
        source = f'{alt_path.rstrip("/")}/{filename}'
        source_type = '–°—Å—ã–ª–∫–∞'

    df = pd.read_csv(source, **params)
    df.attrs['name'] = filename

    display(Markdown(
        f"### –§–∞–π–ª `{filename}` –∑–∞–≥—Ä—É–∂–µ–Ω\n\n"
        f"**–¢–∏–ø –∏—Å—Ç–æ—á–Ω–∏–∫–∞**: {source_type}  \n"
        f"**–ò—Å—Ç–æ—á–Ω–∏–∫**: `{source}`"
    ))

    return df


# In[4]:


def get_df_overview(df, discrete=None, section_name=None):
    def section(title):
        display(Markdown(f'### {title}\n___\n'))
    
    def show_info():
        section(f'–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ DataFrame:')
        buffer = StringIO()
        df.info(buf=buffer)
        info_str = buffer.getvalue()
        display(Markdown(f'```{info_str}```'))
        
    def show_description():
        section('–°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö')
        
        display(df.describe())
        
    def show_sample():
        section('5 —Å–ª—É—á–∞–π–Ω—ã—Ö —Å—Ç—Ä–æ–∫')
        
        display(df.sample(5))
        
    def show_unique():
        section('–ö–æ–ª-–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π')
        
        unique_vals = df.nunique().sort_values(ascending=False).to_frame('unique_values')
        
        display(unique_vals)
        
    def show_missing():
        section('–ö–æ–ª-–≤–æ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π')
        
        missing = df.isna().sum().to_frame('missing_values')
        missing['missing_pct'] = (missing['missing_values'] / len(df) * 100).round(2)
        
        if missing['missing_values'].sum() == 0:
            display(Markdown('‚úÖ **–ü—Ä–æ–ø—É—Å–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç!**'))
        else:
            display(missing[missing.missing_values != 0])

        
    def show_duplicates_explicit():
        section('–Ø–≤–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã')
        count = df.index.duplicated().sum()
        
        if count == 0:
            display(Markdown('‚úÖ –Ø–≤–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã **–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç!**'))
        else:
            display(Markdown(f'**–ù–∞–π–¥–µ–Ω–æ:** {count}'))
            display(df[df.duplicated()])
            
    def show_duplicates_implicit():
        section('–ù–µ—è–≤–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã')
        
        found = False
        
        for col in df.select_dtypes(include=['object', 'category']):
            vals = df[col].dropna().astype(str)
            normed = vals.str.lower().str.strip()
            rev = vals.groupby(normed).unique()
            
            for norm_val, origs in rev.items():
                if len(origs) > 1:
                    found = True
                    display(Markdown(f'- **{col}**: {list(origs)} ‚Üí –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ `{norm_val}`'))
                    
        if not found:
            display(Markdown('‚úÖ –ù–µ—è–≤–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã **–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç!**'))
            
    
    def get_top_n_series(series, n=15):
        counts = series.value_counts()
        
        if len(counts) <= n:
            return series

        top_cats = counts.head(n).index
        
        return series.where(series.isin(top_cats), f'+OTHER')


    def show_fast_plot_analysis(df=df, discrete=discrete):
        section('–ë–µ–≥–ª—ã–π –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑')
        
        num_cols = [col for col in df.columns if discrete is None or col not in discrete]
        
        if num_cols:
            section('–ö–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏')
            n_cols = 3
            n_rows = (len(num_cols) + n_cols - 1) // n_cols

            fig, axes = plt.subplots(
                n_rows,
                n_cols,
                figsize=(18, 4 * n_rows)
            )
            
            axes = axes.flatten()

            for col, ax in zip(num_cols, axes):
                sns.histplot(
                    df[col],
                    bins=BINS,
                    color=COLOR_SINGLE_BASIC,
                    ax=ax
                )
                
                ax.set_xlabel(X_CAPTION_NUMERIC)
                ax.set_ylabel(Y_CAPTION_NUMERIC_FREQ)
                ax.set_title(col)
                
                for label in ax.get_xticklabels():
                    label.set_rotation(45)
                    
            for ax in axes[len(num_cols):]:
                ax.set_visible(False)

            plt.tight_layout()
            plt.show()

        if discrete:
            section('–î–∏—Å–∫—Ä–µ—Ç–Ω—ã–µ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏')
            n_cols = 3
            n_rows = (len(discrete) + n_cols - 1) // n_cols

            fig, axes = plt.subplots(
                n_rows,
                n_cols,
                figsize=(18, 6 * n_rows)
            )
            
            axes = axes.flatten()

            for col, ax in zip(discrete, axes):
                modified_series = get_top_n_series(df[col], n=15)
                
                sns.countplot(
                    x=modified_series,
                    order= modified_series.value_counts().index,
                    ax=ax,
                    color=COLOR_SINGLE_BASIC
                )
                
                ax.set_xlabel(X_CAPTION_NUMERIC)
                ax.set_ylabel(Y_CAPTION_NUMERIC_FREQ)
                ax.set_title(col)
                
                for label in ax.get_xticklabels():
                    label.set_rotation(45)
            for ax in axes[len(discrete):]:
                ax.set_visible(False)

            plt.tight_layout()
            plt.show()
                    
    sections = {
        'info': show_info,
        'description': show_description,
        'sample': show_sample,
        'unique': show_unique,
        'missing': show_missing,
        'duplicates_explicit': show_duplicates_explicit,
        'duplicates_implicit': show_duplicates_implicit,
        'fast_plot_analysis': show_fast_plot_analysis,
    }
    
    display(Markdown(f'## üîé –û–±–∑–æ—Ä –¥–∞–Ω–Ω—ã—Ö `{df.attrs["name"]}`'))
        
    if section_name is None:
        for func in sections.values():
            func()
    else:
        func = sections.get(section_name)
        func()


# ### –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
# ___

# In[5]:


# –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
path = 'datasets'

loading_params = dict(
    index_col='customerID',
    sep=',',
    decimal='.',
    encoding='utf-8',
    na_values=['', ' ', 'null', 'NULL']
)


# In[6]:


# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
df_contract_new = load_data(
    'contract_new.csv',
    path,
    parse_dates=['BeginDate', 'EndDate'],
    converters={'EndDate': lambda x: np.nan if x in ['No', 'no', '', ' '] else x},
    **loading_params
)

df_personal_new = load_data(
    'personal_new.csv',
    path,
    **loading_params
)

df_internet_new = load_data(
    'internet_new.csv', 
    path, 
    **loading_params
)

df_phone_new = load_data(
    'phone_new.csv', 
    path, 
    **loading_params
)


# ### –ò–∑—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö `df_contract_new`
# ___

# In[7]:


get_df_overview(
    df_contract_new,
    discrete=[
        'Type',
        'PaperlessBilling',
        'PaymentMethod'
    ]
)


# ### –ò–∑—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö `df_personal_new`
# ___

# In[8]:


get_df_overview(
    df_personal_new,
    discrete=list(df_personal_new.columns)
)


# ### –ò–∑—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö `df_internet_new`
# ___

# In[9]:


get_df_overview(
    df_internet_new,
    discrete=list(df_internet_new.columns)
)


# ### –ò–∑—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö `df_phone_new`
# ___

# In[10]:


get_df_overview(
    df_phone_new,
    discrete=list(df_phone_new.columns)
)


# ### –í—ã–≤–æ–¥—ã
# ___
# 
# **–û–ø–∏—Å–∞–Ω–∏–µ `df_contract_new`**
# > - **–†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –¥–∞—Ç–∞—Ñ—Ä–µ–π–º–∞**: 7043 √ó 7
# > - **–ò–Ω–¥–µ–∫—Å –¥–∞—Ç–∞—Ñ—Ä–µ–π–º–∞**: `customerID`, –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã
# > - **–î–∏—Å–∫—Ä–µ—Ç–Ω—ã–µ / –ö–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏**:
# > ```python
# > 'Type', 'PaperlessBilling', 'PaymentMethod'
# > ```
# > - **–ö–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏**:
# > ```python
# > 'MonthlyCharges', 'TotalCharges'
# > ```
# > - **–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è**:
# >
# >    - `TotalCharges` - 11 –ø—Ä–æ–ø—É—Å–∫–æ–≤
# >    - `EndDate` - –ø—Ä–æ–ø—É—Å–∫–∏ —Å–≤—è–∑–∞–Ω—ã —Å –µ—â–µ –Ω–µ –∑–∞–∫—Ä—ã—Ç—ã–º–∏ –¥–æ–≥–æ–≤–æ—Ä–∞–º–∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è
# > - **–Ø–≤–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã**: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
# > - **–ù–µ—è–≤–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã**: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
# > - **–ù–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫, —Å—Ç–æ–ª–±—Ü–æ–≤ –∏ –ø—Ä.**: –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–±—â–µ–ø—Ä–∏–Ω—è—Ç–æ–º—É —Å—Ç–∏–ª—é
# > - **–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏**: –¥–∞
# ---
# **–û–ø–∏—Å–∞–Ω–∏–µ `df_personal_new`**
# > - **–†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –¥–∞—Ç–∞—Ñ—Ä–µ–π–º–∞**: 7043 √ó 4
# > - **–ò–Ω–¥–µ–∫—Å –¥–∞—Ç–∞—Ñ—Ä–µ–π–º–∞**: `customerID`, –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã
# > - **–î–∏—Å–∫—Ä–µ—Ç–Ω—ã–µ / –ö–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏**: –≤—Å–µ
# > - **–ö–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏**: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
# > - **–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è**: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
# > - **–Ø–≤–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã**: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
# > - **–ù–µ—è–≤–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã**: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
# > - **–ù–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫, —Å—Ç–æ–ª–±—Ü–æ–≤ –∏ –ø—Ä.**: –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–±—â–µ–ø—Ä–∏–Ω—è—Ç–æ–º—É —Å—Ç–∏–ª—é
# > - **–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏**: –¥–∞
# ---
# **–û–ø–∏—Å–∞–Ω–∏–µ `df_internet_new`**
# > - **–†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –¥–∞—Ç–∞—Ñ—Ä–µ–π–º–∞**: 5517 √ó 7
# > - **–ò–Ω–¥–µ–∫—Å –¥–∞—Ç–∞—Ñ—Ä–µ–π–º–∞**: `customerID`, –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã
# > - **–î–∏—Å–∫—Ä–µ—Ç–Ω—ã–µ / –ö–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏**: –≤—Å–µ
# > - **–ö–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏**: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
# > - **–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è**:    –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
# > - **–Ø–≤–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã**: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
# > - **–ù–µ—è–≤–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã**: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
# > - **–ù–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫, —Å—Ç–æ–ª–±—Ü–æ–≤ –∏ –ø—Ä.**: –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–±—â–µ–ø—Ä–∏–Ω—è—Ç–æ–º—É —Å—Ç–∏–ª—é
# > - **–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏**: –¥–∞
# ---
# **–û–ø–∏—Å–∞–Ω–∏–µ `df_phone_new`**
# > - **–†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –¥–∞—Ç–∞—Ñ—Ä–µ–π–º–∞**: 6361 √ó 1
# > - **–ò–Ω–¥–µ–∫—Å –¥–∞—Ç–∞—Ñ—Ä–µ–π–º–∞**: `customerID`, –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã
# > - **–î–∏—Å–∫—Ä–µ—Ç–Ω—ã–µ / –ö–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏**:–≤—Å–µ
# > - **–ö–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏**: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
# > - **–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è**:    –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
# > - **–Ø–≤–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã**: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
# > - **–ù–µ—è–≤–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã**: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç
# > - **–ù–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫, —Å—Ç–æ–ª–±—Ü–æ–≤ –∏ –ø—Ä.**: –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–±—â–µ–ø—Ä–∏–Ω—è—Ç–æ–º—É —Å—Ç–∏–ª—é
# > - **–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏**: –¥–∞

# ## –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
# ___

# ### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏
# ___

# In[11]:


def col_names_cleaner(df):
    df.columns = (
        df.columns
        .str.replace(r'([A-Z])', r'_\1', regex=True)
        .str.lower()
        .str.replace(r' ', '_')
        .str.strip('_')
    )
        
    return df


# In[12]:


def text_cleaner(df):
    text_columns = df.select_dtypes(include=['object']).columns
    
    for col in text_columns:
        df[col] = df[col].str.lower()
    
    return df


# In[13]:


def get_short_df_info(df):
    results = []
   
    for col in df:
        results.append({
            '–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö': df[col].dtype,
            '–£–Ω–∏–∫. –≤—Å–µ–≥–æ.': df[col].nunique(),
            '–£–Ω–∏–∫. –∑–Ω–∞—á–µ–Ω–∏—è': df[col].unique(),
            'NaN (–∫–æ–ª-–≤–æ.)': df[col].isna().sum(),
            'NaN (%)': df[col].isnull().mean().round(4),
        })
        
    main_info = pd.DataFrame(data=results).set_index(df.columns)
    
    display(Markdown(f'### –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –¥–∞—Ç–∞—Ñ—Ä–µ–π–º—É `{df.attrs["name"]}`\n___\n'))
    display(Markdown(f'–†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å: {df.shape}'))
    
    return main_info


# ### –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
# ___

# In[14]:


# –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–ø–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã
cleaned_contract_new = df_contract_new.copy()
cleaned_internet_new = df_internet_new.copy()
cleaned_personal_new = df_personal_new.copy()
cleaned_phone_new = df_phone_new.copy()


cleaned_contract_new.attrs['name'] = 'cleaned_contract_new'
cleaned_internet_new.attrs['name'] = 'cleaned_internet_new'
cleaned_personal_new.attrs['name'] = 'cleaned_personal_new'
cleaned_phone_new.attrs['name'] = 'cleaned_phone_new'


# In[15]:


# –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—Å–µ–º –¥–∞—Ç–∞—Ñ—Ä–µ–π–º–∞–º
for df in (cleaned_contract_new, cleaned_internet_new, cleaned_personal_new, cleaned_phone_new):
    col_names_cleaner(df)
    text_cleaner(df)
    df.index.name = 'uid'
    
    obj_dtypes = df.select_dtypes(include=['object']).columns
    df[obj_dtypes] = df[obj_dtypes].astype('category')


# In[16]:


# –ó–∞–º–µ–Ω—Ç–∞ —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Å—Ç–æ–ª–±—Ü–µ 'senior_citizen'
cleaned_personal_new.senior_citizen = (
    cleaned_personal_new
    .senior_citizen
    .replace({0: 'no', 1:'yes'})
    .astype('category')
)


# In[17]:


# –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—â–µ–≥–æ –ø—Ä–∏–∑–Ω–∞–∫–∞ –ø–æ –∫–æ–ª-–≤—É –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
service_cols = [
    'online_security',
    'online_backup',
    'device_protection',
    'tech_support',
    'streaming_t_v',
    'streaming_movies'
]

cleaned_internet_new['connected_services_count'] = (
    (cleaned_internet_new[service_cols] != 'no')
    .sum(axis=1)
    .astype('category')
)


# In[18]:


# –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—á–∏—â–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
for df in (cleaned_contract_new, cleaned_internet_new, cleaned_personal_new, cleaned_phone_new):
    display(get_short_df_info(df))


# ### –û–±—å–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
# ___

# In[19]:


# –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
df_full = (
    cleaned_contract_new
    .merge(cleaned_internet_new, on='uid',how='left')
    .merge(cleaned_personal_new, on='uid',how='left')
    .merge(cleaned_phone_new, on='uid',how='left')
)

df_full.attrs['name'] = 'df_full'

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ—è–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤
get_short_df_info(df_full)


# In[20]:


# –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—è–≤–∏–≤—à–∏—Ö—Å—è –ø—Ä–æ–ø—É—Å–∫–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ unknown
cat_cols = df_full.select_dtypes('category').columns

df_full[cat_cols] = (
    df_full[cat_cols]
    .astype('object')
    .fillna('unknown')
    .astype('category')
)


# In[21]:


# –ó–∞–º–µ–Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è unknown –Ω–∞ 0 –≤ connected_services_count
# –°—á–∏—Ç–∞–µ–º –∫–∞–∫ –æ—Ç—Å—É—Å—Ç–≤–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ –ø—Ä–∏–Ω—Ü–∏–ø–µ
df_full.connected_services_count = (
    df_full.connected_services_count
    .astype('object')
    .replace('unknown', -1)
    .astype(int)
    .astype('category')
)


# In[22]:


# –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ–ø—É—Å–∫–æ–≤ –≤ total_charges
df_full[df_full.total_charges.isna()]


# In[23]:


# –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤ –≤ total_charges
# –°–ª–∏—à–∫–æ–º —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ, —É–¥–∞–ª–µ–Ω–∏–µ –Ω–∏–∫–∞–∫ –Ω–µ –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
df_full = df_full[df_full.total_charges.notna()]


# In[24]:


# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ begin_date –∏ end_date
# –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –≤ –¥–Ω—è—Ö –Ω–∞ 01.02.2020
end_date = df_full['end_date'].fillna(pd.to_datetime('2020-02-01'))
df_full['contract_duration_days'] = (end_date - df_full['begin_date']).dt.days

# –ü—Ä–∏–∑–Ω–∞–∫ user_left - –ø–æ–∫–∞–∂–µ—Ç, —É—à–µ–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
df_full['user_left'] = np.where(df_full['end_date'].isna(), 0, 1)
df_full['user_left'] = df_full['user_left'].astype('category')

# –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫ —Å –¥–∞—Ç–∞–º–∏ –≤–æ –∏–∑–±–µ–∂–∞–Ω–∏–µ —É—Ç–µ—á–∫–∏ –¥–∞–Ω–Ω—ã—Ö
df_full = df_full.drop(['begin_date', 'end_date'], axis=1)


# In[25]:


# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–∞—Ç–∞—Ñ—Ä–µ–π–º–∞
get_short_df_info(df_full)


# ### –í—ã–≤–æ–¥—ã
# ___
# 
# **–ò—Ç–æ–≥–∏ –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö:**
# > - –ë—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã –∫–æ–ø–∏–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö
# > - –ö–æ–ª–æ–Ω–∫–∏ –±—ã–ª–∏ –æ—á–∏—â–µ–Ω—ã –∏ –ø—Ä–∏–≤–µ–¥–µ–Ω—ã –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
# > - –¢–µ–∫—Å—Ç –≤ –ø—Ä–∏–∑–Ω–∞–∫–∞—Ö –±—ã–ª –æ—á–∏—â–µ–Ω –∏ –ø—Ä–∏–≤–µ–¥–µ–Ω –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
# > - –ò–º—è –∫–æ–ª–æ–Ω–∫–∏ —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏ `customerID` –±—ã–ª–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ –≤ `uid`
# > - –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ç–∏–ø–∞ `object` –±—ã–ª–∏ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–∏–ø `category`
# > - –í –∫–æ–ª–æ–Ω–∫–µ `senior_citizen` –±–∏–Ω–∞—Ä–Ω—ã–π –ø—Ä–∏–∑–Ω–∞–∫ –±—ã–ª –ø—Ä–∏–≤–µ–¥–µ–Ω –∫ —Ñ–æ—Ä–º–∞—Ç—É `yes, no`, –∞ —Ç–∞–∫–∂–µ –∫ —Ç–∏–ø—É –¥–∞–Ω–Ω—ã—Ö `category`
# > - –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –æ–±—â–∏–π –ø—Ä–∏–∑–Ω–∞–∫ –ø–æ –∫–æ–ª-–≤—É –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ `connected_services_count`
# 
# **–ò—Ç–æ–≥–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:**
# > - –í—Å–µ –¥–∞—Ç–∞—Ñ—Ä–µ–π–º—ã –±—ã–ª–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –ø–æ `uid` 
# > - –û—á–∏—â–µ–Ω—ã –ø—Ä–æ–ø—É—Å–∫–∏ –≤ –∫–æ–ª-–≤–µ 11 –µ–¥.(–≤—Å–µ–≥–æ 0.2%) —Å—Ç–æ–ª–±—Ü–µ `total_charges`, —Ç.–∫. –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω—É–ª–µ–≤–∞—è –∏ –∏—Ö –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –¥–∞–ª—å–Ω–µ–π—à–µ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ
# > - –ü—Ä–æ–ø—É—Å–∫–∏ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –±—ã–ª–∏ –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ `unknown`-–∑–Ω–∞—á–µ–Ω–∏–µ (–≤–µ—Ä–æ—è—Ç–Ω–æ, –ø—Ä–æ–ø—É—Å–∫–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω—ã —Å –æ—Ç—Å—É—Å—Ç–≤–∏–µ–º —É—Å–ª—É–≥–∏ –≤ —Ü–µ–ª–æ–º, –Ω–æ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ —ç—Ç–æ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ)
# > - –ù–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–ª–æ–Ω–æ–∫ —Å –¥–∞—Ç–∞–º–∏ `begin_date` –∏ `end_date` –±—ã–ª–∏ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω—ã –Ω–æ–≤—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏:
# > 	- `contract_duration_days` - –æ–±—â–∏–π —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞
# > 	- **`user_left` - —Ü–µ–ª–µ–≤–æ–π –ø—Ä–∏–∑–Ω–∞–∫**, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —É—à–µ–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ –º–æ–º–µ–Ω—Ç 01.02.2020 –∏–ª–∏ –Ω–µ—Ç
# > - –í —Å–ª–µ–¥—Å—Ç–≤–∏–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤, –∫–æ–ª–æ–Ω–∫–∏ `begin_date` –∏ `end_date` –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã –∑–∞ –Ω–µ–Ω–∞–¥–æ–±–Ω–æ—Å—Ç—å—é

# ## –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö
# ___

# ### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
# ___

# In[26]:


def display_stats(feature):
    display(feature.describe().to_frame().round(2).T)


# In[27]:


def show_corr_heatmap_plot(df, target=TARGET_FEATURE):
    display(Markdown(f'### –ú–∞—Ç—Ä–∏—Ü–∞ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ Phi_K\n___'))
    
    interval_cols = df.select_dtypes(exclude=['category', object]).columns
    corr_matrix = df.phik_matrix(interval_cols=interval_cols)
    corr_mask = np.triu(np.ones(corr_matrix.shape), k=1)
    
    plt.figure(figsize=FIGSIZE_SQUARED)

    sns.heatmap(
        data=corr_matrix,
        mask=corr_mask,
        annot=True,
        cmap=PALETTE_CAT_ALT,
        square=True,
        cbar=False,
        vmin=-1,
        vmax=1,
        fmt='.2f',
        linewidths=3,
    )
    
    plt.tight_layout()
    plt.show()
    
    get_corr_levels(
        corr_matrix, 
        corr_mask,
        target if target else None
    )

def get_corr_levels(corr_matrix, corr_mask, target=None):    
    def interpret(value):
        if value >= 0.9: return '–û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è'
        elif value >= 0.7: return '–í—ã—Å–æ–∫–∞—è'
        elif value >= 0.5: return '–ó–∞–º–µ—Ç–Ω–∞—è'
        elif value >= 0.3: return '–£–º–µ—Ä–µ–Ω–Ω–∞—è'
        elif value > 0: return '–°–ª–∞–±–∞—è'
        else: return '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'

    pairs = (
        corr_matrix
        .stack()
        .reset_index()
    )
    
    pairs.columns = ['Target', 'Secondary', 'corr']
    pairs = pairs[pairs['Target'] != pairs['Secondary']]
    pairs['corr'] = pairs['corr'].round(2)
    pairs['lvl'] = pairs['corr'].apply(interpret)
        
    if target is not None:
        pairs = pairs[(pairs['Target'] == target) & (pairs['Secondary'] != target)]
        
        title = f'### –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è –ø–æ –ø—Ä–∏–∑–Ω–∞–∫—É: `{target}`'
    else:
        title = '### –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –ø–æ –≤—Å–µ–º –ø—Ä–∏–∑–Ω–∞–∫–∞–º'
    
    display(Markdown(f'{title}\n___\n'))
    display(pairs.sort_values('corr', ascending=False).reset_index(drop=True))


# In[28]:


def show_class_distribution(df):
    display(Markdown(f'### –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤ `{TARGET_FEATURE}`\n___'))

    class_dist = df[TARGET_FEATURE].value_counts().sort_index()
    class_pct = (df[TARGET_FEATURE].value_counts(normalize=True) * 100).sort_index()
    imbalance_ratio = class_dist.max() / class_dist.min()
    
    plt.figure(figsize=FIGSIZE_SINGLE)
    
    sns.countplot(data=df, x=TARGET_FEATURE, palette=PALETTE_CAT)
    
    plt.title('–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤', **FONT_TITLE_KWARGS)
    plt.xlabel('–ö–ª–∞—Å—Å', fontsize=FONT_SIZE_LABEL)
    plt.ylabel(Y_CAPTION_CAT, fontsize=FONT_SIZE_LABEL)
    plt.tight_layout()
    plt.show()
    
    dist_df = pd.DataFrame({
        '–ö–ª–∞—Å—Å': class_dist.index,
        '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ': class_dist.values,
        '–ü—Ä–æ—Ü–µ–Ω—Ç': [f"{pct:.2f}%" for pct in class_pct.values]
    })
    
    display(Markdown(f'**–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –¥–∏—Å–±–∞–ª–∞–Ω—Å–∞ –∫–ª–∞—Å—Å–æ–≤:** ‚âà{imbalance_ratio:.0f}:1'))
    display(dist_df)


# In[29]:


def show_bar_pie_plot(df, x, y=None, hue=None, top_n=12):        
    counts = df[x].value_counts()
    top = counts.head(top_n)
    other = counts.iloc[top_n:].sum()
    counts = pd.concat([top, pd.Series({'Other': other})]) if other > 0 else top
    values = counts.values
    categories = counts.index.astype(str).str.capitalize().str.replace('_',' ')
    palette = sns.color_palette(PALETTE_CAT, len(counts))
    suptitle = x.capitalize().replace('_', ' ')
    
    fig, (ax_1, ax_2) = plt.subplots(
        figsize=FIGSIZE_SINGLE, 
        ncols=2
    )
    
    sns.barplot(
        x=categories,
        y=values,
        hue=categories,
        palette=palette,
        ax=ax_1
    )

    ax_1.set(
        xlabel=X_CAPTION_CAT,
        ylabel=Y_CAPTION_CAT
    )
    
    ax_2.pie(
        values,
        labels=categories,
        autopct=lambda pct: f'{pct:.1f}%' if pct > 3 else '',
        startangle=90,
        labeldistance=1.1,
        colors=palette,
        wedgeprops={'width': 0.8, 'edgecolor': 'w'},
        pctdistance=0.6
    )
            
    fig.suptitle(
        suptitle,
        **FONT_SUBTITLE_KWARGS
    )
    
    plt.tight_layout()
    plt.show()

    display_stats(df[x])


# In[30]:


def show_hist_box_plot(df, x, y=None, hue=None):
    suptitle = x.capitalize().replace('_', ' ')
    
    fig, (ax_1, ax_2) = plt.subplots(
        figsize=FIGSIZE_DOUBLE,
        nrows=2
    )
        
    hist_kwargs = dict(
        data=df,
        x=x,
        bins=BINS, 
        kde=True,
        ax=ax_1
    )
    
    box_kwargs = dict(
        data=df,
        x=x,
        orient='h',
        ax=ax_2
    )
    
    if y:
        box_kwargs.update(y=y)
        
    if hue:
        hist_kwargs.update(hue=hue, palette=PALETTE_NUMERIC)
        box_kwargs.update(hue=hue, palette=PALETTE_NUMERIC)
    else:
        hist_kwargs.update(color=COLOR_SINGLE_BASIC)
        box_kwargs.update(color=COLOR_SINGLE_BASIC)
        
    sns.histplot(**hist_kwargs)
    sns.boxplot(**box_kwargs)
    
    for ax in (ax_1, ax_2):
        ax.set(
            xlabel=X_CAPTION_NUMERIC,
            ylabel=Y_CAPTION_NUMERIC_FREQ
        )

    fig.suptitle(
        suptitle, 
        y=1, 
        size=16,
        weight='bold'
    )
    
    plt.tight_layout()
    plt.show()
    
    display_stats(df[x])


# In[31]:


def show_full_analysis_plots(df,
                             y=None,
                             hue=None,
                             analysis_type='full'):
    display(Markdown(f'### –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö: `{analysis_type}`'))

    has_data = False
    
    for col in df.columns:
        is_numeric_dtype = pd.api.types.is_numeric_dtype(df[col])
        
        if is_numeric_dtype:
            if analysis_type in ('full', 'num'):
                show_hist_box_plot(df, col, y=y, hue=hue)
                has_data = True
        else:
            if analysis_type in ('full', 'cat'):
                show_bar_pie_plot(df, col, y=y, hue=hue)
                has_data = True
    
    if not has_data:
        display(Markdown('‚ÑπÔ∏è –í –¥–∞—Ç–∞—Ñ—Ä–µ–π–º–µ **–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞**'))


# In[32]:


def show_compared_histplots(df_combined,
                            features,
                            discrete=None):
    display(Markdown(f'### –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö \n___'))
    
    color = sns.color_palette(PALETTE_NUMERIC)
    num_cols = [col for col in features if discrete is None or col not in discrete]
    
    if num_cols:
        n_cols = 2
        n_rows = (len(num_cols) + n_cols - 1) // n_cols
    
        fig, axes = plt.subplots(
            n_rows, 
            n_cols, 
            figsize=(18, 4 * n_rows)
        )

        fig.suptitle('–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–µ', **FONT_SUBTITLE_KWARGS)
        
        axes = axes.flatten()

        for col, ax in zip(num_cols, axes):            
            sns.histplot(
                data=df_combined,
                x=col,
                palette=PALETTE_NUMERIC,
                alpha=ALPHA_FILL,
                hue='dataset',
                stat='density',
                common_norm=False,
                kde=True,
                ax=ax
            )

            ax.set_title(col.capitalize().replace('_', ' '), fontsize=12, weight='bold')
            ax.set_xlabel(X_CAPTION_NUMERIC)
            ax.set_ylabel(Y_CAPTION_NUMERIC_FREQ)

        for ax in axes[len(num_cols):]:        
            ax.set_visible(False)

        plt.tight_layout()
        plt.show()
    
    if discrete.any():
        n_cols = 2
        n_rows = (len(discrete) + n_cols - 1) // n_cols
        
        fig, axes = plt.subplots(
            n_rows,
            n_cols,
            figsize=(18, 4 * n_rows)
        )
        
        fig.suptitle('–ö–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–µ', **FONT_SUBTITLE_KWARGS)
        
        axes = axes.flatten()

        for col, ax in zip(discrete, axes):            
            sns.countplot(
                data=df_combined,
                x=col,
                palette=PALETTE_NUMERIC,
                hue='dataset',
                alpha=ALPHA_FILL,
                stat='percent',
                ax=ax
            )
            
            ax.set_title(col.capitalize().replace('_', ' '), fontsize=12, weight='bold')
            ax.set_xlabel(X_CAPTION_NUMERIC)
            ax.set_ylabel(Y_CAPTION_NUMERIC_FREQ)

        for ax in axes[len(discrete):]:        
            ax.set_visible(False)

        plt.tight_layout()
        plt.show()


# ### –û–±—â–∏–π –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö
# ___

# In[33]:


# –í—ã–≤–æ–¥ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –ø–æ —á–∏—Å–ª–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º
show_full_analysis_plots(df_full, analysis_type='num')


# In[34]:


# –í—ã–≤–æ–¥ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –ø–æ —á–∏—Å–ª–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º
show_full_analysis_plots(df_full, analysis_type='cat')


# In[35]:


# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥–∏—Å–±–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤ —Ü–µ–ª–µ–≤–æ–≥–æ –ø—Ä–∏–∑–Ω–∞–∫–∞
show_class_distribution(df_full)


# #### –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –≤—ã–≤–æ–¥—ã
# ---
# 
# **–ê–Ω–∞–ª–∏–∑ —á–∏—Å–ª–µ–Ω–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤**
# > - **`monthly_charges`** –∏–º–µ–µ—Ç –æ–¥–Ω—É —è–≤–Ω—É—é –≤–µ—Ä—à–∏–Ω—É —Å–ª–µ–≤–∞, —á—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –æ –±–æ–ª—å—à–æ–º –∫–æ–ª-–≤–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –Ω–∏–∑–∫–æ–π –µ–∂–µ–º–µ—Å—è—á–Ω–æ–π –æ–ø–ª–∞—Ç–æ–π —É—Å–ª—É–≥
# >
# >
# > - **`total_charges`** —è–≤–Ω–æ —Å–∫–æ—à–µ–Ω –≤–ø—Ä–∞–≤–æ, —Ç.–∫. –∏–º–µ–µ—Ç –∞–Ω–æ–º–∞–ª–∏–∏ –≤ –≤–∏–¥–µ –≤—ã—Å–æ–∫–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π —Å—É–º–º—ã –æ–ø–ª–∞—Ç –≤ —Ç–æ—Ç–∞–ª–µ, –Ω–æ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π –∏–º–µ–µ—Ç –º–∞–ª—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è. –í—ã–±—Ä–æ—Å—ã —Å—Ç–æ–∏—Ç –æ—Å—Ç–∞–≤–∏—Ç—å, —Ç.–∫. –æ–Ω–∏ –∏–º–µ—é—Ç –≤–∞–∂–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç, —Å–∫–æ–ª—å–∫–æ –≤ –æ–±—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø–ª–∞—Ç–∏–ª –∑–∞ —É—Å–ª—É–≥–∏ –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è
# >
# >
# > - **`contract_duration_days`** –∏–º–µ–µ—Ç –¥–≤–µ —è–≤–Ω—ã–µ –≤–µ—Ä—à–∏–Ω—ã —Å–ª–µ–≤–∞ –∏ —Å–ø—Ä–∞–≤–∞, —á—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –∫–∞–∫ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö —Å –¥–ª–∏—Ç–µ–ª—å–Ω—ã–º –¥–æ–≥–æ–≤–æ—Ä–æ–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è, —Ç–∞–∫ –∏ —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ–Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
# ---
# **–ê–Ω–∞–ª–∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤**
# > - **`type`** –∏–º–µ–µ—Ç —è–≤–Ω—ã–π –ø–µ—Ä–µ–≤–µ—Å –≤ —Å—Ç–æ—Ä–æ–Ω—É —Ç–∏–ø–∞ –ø–ª–∞—Ç–µ–∂–∞ **`month-to-month - 55.1%`, —á—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç –æ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–∏ –µ–∂–µ–º–µ—Å—è—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–æ–≤ –ø–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—é –∫ –æ—Å—Ç–∞–ª—å–Ω—ã–º**
# >
# >
# > - **`paperless_billing`** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ **`59.3%` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–ª—É—á–∞—é—Ç —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ —Ä–∞—Å—á–µ—Ç–Ω—ã–µ –ª–∏—Å—Ç–∫–∏**
# >
# >
# > - **`payment_method`** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ **–Ω–∞–∏–±–æ–ª—å—à–µ–µ —á–∏—Å–ª–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–ª—å–∑—É–µ—Ç—Å—è —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–º –º–µ—Ç–æ–¥–æ–º –ø–ª–∞—Ç–µ–∂–∞ `electronic check - 33.6%`**, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∏–º–µ—é—Ç –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–≤–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ - **`‚âà22%`**
# >
# >
# > - **`internet_sevice`** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ **`44% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`** –∏–º–µ—é—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É —Ç–∏–ø–∞ **`fiber-optic`**, –ø—Ä–∏ —ç—Ç–æ–º **`34.4% - dsl`**, –∞ —Ç–∏–ø **`unknown` –º–æ–∂–µ—Ç –≥–æ–≤–æ—Ä–∏—Ç—å –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É —É `21.6%` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**
# >
# >
# > - –ü—Ä–∏–∑–Ω–∞–∫–∏ **`online_security, online_backup, device_protection, tech_support, streaming_t_v, streaming_movies`** –∏–º–µ—é—Ç –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –∏–¥–µ–Ω—Ç–∏—á–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤ –¥–∞–Ω–Ω—ã—Ö, –ø–æ—ç—Ç–æ–º—É —Ä–∞–∑—É–º–Ω–µ–µ –±—É–¥–µ—Ç –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –æ–±—â–µ–µ –∫–æ–ª–∏–µ—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
# >
# >
# > - **`connected_services_count`** –æ—Ç–Ω–µ—Å –Ω–∞–∏–±–æ–ª—å—à–µ–µ —á–∏—Å–ª–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ **`-1`** (–≤–µ—Ä–æ—è—Ç–Ω–æ, –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤–æ–≤—Å–µ –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ –±—ã–ª–∏ –Ω–µ –≤–Ω–µ—Å–µ–Ω—ã), –Ω–æ –≤ —Ü–µ–ª–æ–º **–Ω–∞–∏–±–æ–ª—å—à–µ–µ —á–∏—Å–ª–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–º–µ–µ—Ç 3 –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–∞, –∞ –∫–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç –æ—Ç 1 –¥–æ 4 –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –≤ –ø—Ä–∏–Ω—Ü–∏–ø–µ**
# >
# >
# > - **`gender`** –∏–º–µ–µ—Ç –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–≤–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ - **`–ø–æ 50% –º—É–∂—á–∏–Ω –∏ –∂–µ–Ω—â–∏–Ω`**
# >
# >
# > - **`senior_citizen`** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –≤—Å–µ–≥–æ **`18.2%` —è–≤–ª—è—é—Ç—Å—è –ª—é–¥—å–º–∏ –ø–µ–Ω—Å–∏–æ–Ω–Ω–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞**
# >
# >
# > - **`partner`** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ **–Ω–∞–ª–∏—á–∏–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –∏–ª–∏ –µ–≥–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–≤–Ω–æ–∑–Ω–∞—á–Ω—ã  - `‚âà50%`**
# >
# >
# > - **`dependents`** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —É **`–≤—Å–µ–≥–æ —É 29.8% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –µ—Å—Ç—å –¥–µ—Ç–∏`**
# >
# >
# > - **`multiple_lines`**  –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Å–ª—É—á–∞–µ–≤ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–º –ª–∏–Ω–∏—è–º (**`48.1% –ø—Ä–æ—Ç–∏–≤ 42.2%`**). –¢–∞–∫–∂–µ –∏–º–µ—é—Ç—Å—è –ø—Ä–∏–∑–Ω–∞–∫–∏ **`unknown`, —á—Ç–æ –º–æ–∂–µ—Ç –≥–æ–≤–æ—Ä–∏—Ç—å –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–ª–∏ –ø–ª–æ—Ö–æ–º —Å–±–æ—Ä–µ –¥–∞–Ω–Ω—ã—Ö**
# >
# >
# > - **`user_left`** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —è–≤–Ω—ã–π **–¥–∏—Å–±–∞–ª–∞–Ω—Å –≤ —Å—Ç–æ—Ä–æ–Ω—É –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–æ—Ç–∏–≤ —É—à–µ–¥—à–∏—Ö - `84.3%` –∏ `15.7%` —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ** –∏–ª–∏ **`—Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ ‚âà5:1`**

# ### –ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

# In[36]:


# –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–±–æ—Ä–æ–∫ –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
active_user = df_full.query('user_left == 0')
left_user = df_full.query('user_left == 1')

df_combined = pd.concat([
    active_user.assign(dataset='active'),
    left_user.assign(dataset='left')
])

# –í—ã–≤–æ–¥ 5 —Å–ª—É—á–∞–π–Ω—ã—Ö —Å—Ç—Ä–æ–∫
df_combined.sample(5).T


# In[37]:


# –ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏
discrete_features = df_full.select_dtypes('category').columns

show_compared_histplots(
    df_combined,
    active_user.columns,
    discrete_features
)


# #### –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –≤—ã–≤–æ–¥—ã
# ---
# **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã—Ö –≤–µ–ª–∏—á–∏–Ω (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ)**
# > - **`monthly_charges`** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–∏–±–æ–ª—å—à–µ–µ —á–∏—Å–ª–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –ø–ª–∞—Ç—è—Ç –≤ –º–µ—Å—è—Ü –º–µ–Ω—å—à–µ. –ü—Ä–∏ —ç—Ç–æ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø—Ä–µ–≤—ã—à–∞—é—Ç —É—à–µ–¥—à–∏—Ö –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
# >
# >
# > - **`total_charges`** —Å–∫–æ—à–µ–Ω—ã –≤–ø—Ä–∞–≤–æ —É –æ–±–æ–∏—Ö –≥—Ä—É–ø–ø. –û–±–µ –≥—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ—á—Ç–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ –≤ —Ç–æ—Ç–∞–ª–µ –ø—Ä–∏–Ω–æ—Å—è—Ç –º–∞–ª—ã–µ –¥–æ—Ö–æ–¥—ã. –ü—Ä–∏ —ç—Ç–æ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ —Ç–æ—Ç–∞–ª—É –ø—Ä–µ–≤—ã—à–∞—é—Ç —É—à–µ–¥—à–∏—Ö –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑.
# >
# >
# > - **`contract_duration_days`** –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Å–∫–æ—à–µ–Ω–Ω–æ—Å—Ç—å —É –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤–ø—Ä–∞–≤–æ, —Ö–æ—Ç—å –∏ –Ω–∞–±–ª—é–¥–∞–µ—Ç—Å—è –µ—â–µ –æ–¥–Ω–∞ –≤–µ—Ä—à–∏–∞ –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ, —á—Ç–æ –ª–æ–≥–∏—á–Ω–æ –≥–æ–≤–æ—Ä–∏—Ç –æ –±–æ–ª—å—à–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –Ω–µ–∫–æ—Ç–æ—Ä–æ–º –æ—Å—Ç–∞—Ç–∫–µ "—Å—Ç–∞—Ä–∏—á–∫–æ–≤". –£ —É—à–µ–¥—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≥—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–µ–º–∏—Ç—Å—è –∫–æ–Ω—Ä–º–∞–ª—å–Ω–æ–º—É
# ---
# 
# **–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π**
# > - **`type`** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞–µ—Ç–ª–∏ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞—é—Ç –±–æ–ª—å—à–µ –ø–æ–º–µ—Å—è—á–Ω—É—é –æ–ø–ª–∞—Ç—É, –≤ —Ç–æ –≤—Ä–µ–º—è –∫–∞–∫ —É—à–µ–¥—à–∏–µ –ø–æ—á—Ç–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ –ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –∫–∞–∂–¥—ã–º –∏–∑ –Ω–∏—Ö
# >
# > - **`paperless_billing`** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –æ–±–µ –≥—Ä—É–ø–ø—ã  –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–ª–∏ –ø–æ–ª—É—á–∞—Ç—å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–µ —Ä–∞—Å—á–µ—Ç–Ω—ã–µ –ª–∏—Å—Ç–∫–∏
# >
# >
# > - **`payment_method`** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Ç–¥–∞—é—Ç –Ω–∞–∏–±–æ–ª—å—à–µ–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–º –ø–ª–∞—Ç–µ–∂–∞–º, –¥–∞–ª–µ–µ –∏–¥–µ—Ç —Ç–∏–ø –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ –º–µ–π–ª. –ü–æ—Å–ª–µ–¥–Ω–∏–º–∏ –∏–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–ª–∞—Ç–µ–∂–∏ –∫—Ä–µ–¥–∏—Ç–Ω–æ–π –∫–∞—Ä—Ç–æ–π –∏ —á–µ—Ä–µ–∑ –±–∞–Ω–∫. –ü—Ä–∏ —ç—Ç–æ–º —É—à–µ–¥—à–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–µ–Ω—å—à–µ –≤–µ–≥–æ –æ—Ç–¥–∞–≤–∞–ª–∏ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞–º —á–µ—Ä–µ–∑ –º–µ–π–ª, –∞ –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –≤ —Ä–∞–≤–Ω–æ–π —Å—Ç–µ–ø–µ–Ω–∏ 
# >
# >
# > - **`internet_sevice`** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —Ç–æ –æ–±–µ –≥—Ä—É–ø–ø—ã —á–∞—â–µ –ø–æ–¥–∫–ª—é—á–∞–ª–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º –æ–ø—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–∞–±–µ–ª—è
# >
# >
# > - –ü—Ä–∏–∑–Ω–∞–∫–∏ **`online_security, online_backup, device_protection, tech_support, streaming_t_v, streaming_movies`** –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ä–∞–≤–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –≤—Å–µ–º —Ç–∏–ø–∞–º –ø–æ–¥–ø–∏—Å–æ–∫ - –≤ –±–æ–ª—å—à–µ–π —Å—Ç–µ–ø–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–ª–∏ —Å–µ—Ä–≤–∏—Å—ã, –Ω–µ–∂–µ–ª–∏ –ø–æ–¥–∫–ª—é—á–∞–ª–∏ 
# >
# >
# > - **`connected_services_count`** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ —É –æ–±–µ–∏—Ö –≥—Ä—É–ø–ø –±—ã–ª–æ/–µ—Å—Ç—å –ø–æ 1-4 –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å–µ—Ä–≤–∏—Å—ã, –Ω–æ –±–æ–ª—å—à–µ–µ —á–∏—Å–ª–æ –ø–æ–¥–ø–∏—Å–æ–∫ –Ω–µ –∏–º–µ—é—Ç –≤–æ–≤—Å–µ
# >
# >
# > - **`gender`** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–¥–µ–Ω—Ç–∏—á–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–∞–∫ –ø–æ –º—É–∂—Å–∫–æ–º—É, —Ç–∞–∫ –∏ –ø–æ –∂–µ–Ω—Å–∫–æ–º—É –ø–æ–ª–µ –≤ –æ–±–µ–∏—Ö –≥—Ä—É–ø–ø–∞—Ö
# >
# >
# > - **`senior_citizen`** –∏–º–µ–µ—Ç —Ç–∞–∫ –∂–µ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–∞—Ö - –ø–µ–Ω—Å–∏–æ–Ω–µ—Ä–æ–≤ —Å—Ä–µ–¥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞–º–Ω–æ–≥–æ –º–µ–Ω—å—à–µ
# >
# >
# > - **`partner`** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –∏–º–µ—é—Ç –ø–∞—Ä—ã, –≤ —Ç–æ –≤—Ä–µ–º—è –∫–∞–∫ —É—à–µ–¥—à–∏–µ —á–∞—â–µ –∏–º–µ–ª–∏ –ø–∞—Ä—É, —á–µ–º –Ω–µ—Ç
# >
# >
# > - **`dependents`** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –¥–µ—Ç–µ–π –æ–¥–∏–Ω–∞–∫–æ–≤–æ –±–æ–ª—å—à–µ –≤ –æ–±–µ–∏—Ö –≥—Ä—É–ø–ø–∞—Ö
# >
# >
# > - **`multiple_lines`** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ä–µ–∂–µ –ø–æ–¥–∫–ª—é—á–∞—é—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –ª–∏–Ω–∏–π, –≤ —Ç–æ –≤—Ä–µ–º—è –∫–∞–∫ —É—à–µ–¥—à–∏–µ –ø–æ–¥–∫–ª—é—á–∞–ª–∏ –∏—Ö —á–∞—â–µ

# ### –ö–æ—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö
# ___

# In[38]:


# –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –æ–±—â–µ–π –º–∞—Ç—Ä–∏—Ü—ã –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
show_corr_heatmap_plot(df_full)


# In[39]:


# –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∏–º–µ—é—Ç —è–≤–Ω—É—é –º—É–ª—å—Ç–∏–∫–æ–ª–ª–∏–Ω–µ—Ä–∞–Ω–æ—Å—Ç—å:
# online_security, online_backup, device_protection, tech_support, streaming_t_v, streaming_movies
#
# –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å total_charges, —Ç.–∫. –æ–Ω —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–º –æ—Ç monthly_charges –∏ contract_duration_days
multicoll_features = [
    'online_security',
    'online_backup',
    'device_protection',
    'tech_support',
    'streaming_t_v',
    'streaming_movies',
    'total_charges'
]

df_final = df_full.drop(multicoll_features, axis=1).copy()

df_final.attrs['name'] = 'df_final'

# –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è –ø–æ–≤–µ—Ä–∫–∞
show_corr_heatmap_plot(df_final)


# In[40]:


# –ü—Ä–∏–∑–Ω–∞–∫–∏ —Å –æ—á–µ–Ω—å —Å–ª–∞–±–æ–π –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–µ–π (<0.10) —Ç–∞–∫–∂–µ –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å
noncorr_features = [
    'type',
    'senior_citizen',
    'paperless_billing',
    'internet_service',
    'dependents',
    'gender'
]

# –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –¥–∞—Ç–∞—Ñ—Ä–µ–π–º–∞ —Å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º –Ω–µ–∫–æ—Ä—Ä–µ–ª–∏—Ä—É—é—â–∏—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
df_final = df_final.drop(noncorr_features, axis=1)

# –í—ã–≤–æ–¥ –ø—Ä–æ–≤–µ—Ä–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –¥–∞—Ç–∞—Ñ—Ä–µ–π–º—É
get_short_df_info(df_final)


# In[41]:


# –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–æ—á–Ω–æ–π –º–∞—Ç—Ä–∏—Ü—ã –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
show_corr_heatmap_plot(df_final)


# #### –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –≤—ã–≤–æ–¥—ã
# ---
# - –°–∏–ª—å–Ω–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è –∏ –º—É–ª—å—Ç–∏–∫–æ–ª–ª–∏–Ω–µ–∞—Ä–Ω–æ—Å—Ç—å –º–µ–∂–¥—É —Ü–µ–ª–µ–≤—ã–º –ø—Ä–∏–∑–Ω–∞–∫–æ–º –∏ –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞
# - –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–∏–ª—å–Ω–∞—è –º—É–ª—å—Ç–∏–∫–æ–ª–ª–∏–Ω–µ–∞—Ä–Ω–æ—Å—Ç—å –º–µ–∂–¥—É –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º —Å–µ—Ä–≤–∏—Å–∞–º. –î–∞–Ω–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã –≤–æ –∏–∑–±–µ–∂–∞–Ω–∏–µ —É—Ç–µ—á–∫–∏ –¥–∞–Ω–Ω—ã—Ö
# - –ù–∞–∏–±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Ü–µ–ª–µ–≤–æ–≥–æ –ø—Ä–∏–∑–Ω–∞–∫–∞ :
# | –ü—Ä–∏–∑–Ω–∞–∫               | –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è |
# | ------------------------ | ---- |
# | contract_duration_days   | 0.37 |
# 
# - –ù–∏–∂–µ –∏–¥—É—Ç –ø—Ä–∏–∑–Ω–∞–∫–∏ —Å –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–µ–π –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –¥–≤—É—Ö –¥–µ—Å—è—Ç–∫–æ–≤:
# | –ü—Ä–∏–∑–Ω–∞–∫               | –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è |
# | ------------------------ | ---- |
# | connected_services_count | 0.27 |
# | monthly_charges          | 0.23 |
# | partner                  | 0.23 |
# | payment_method           | 0.21 |
# 
# - –¢–∞–∫–∂–µ –Ω–µ–±–æ–ª—å—à–∞—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –¥–µ—Å—è—Ç–∫–æ–≤ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –ø—Ä–∏–∑–Ω–∞–∫–∞—Ö:
# | –ü—Ä–∏–∑–Ω–∞–∫               | –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è |
# | ------------------------ | ---- |
# | multiple_lines           | 0.11 |
# 

# ### –í—ã–≤–æ–¥—ã
# ---
# > - **–û–±—â–∏–π –∞–Ω–∞–ª–∏–∑** –ø–æ–∫–∞–∑–∞–ª –∞–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –∏ –≤—ã—è–≤–∏–ª –∫–ª—é—á–µ–≤—ã–µ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –≥—Ä—É–ø–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∞ —Ç–∞–∫–∂–µ, —á—Ç–æ –≤ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –¥–∏—Å–±–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤ –≤ —Ü–µ–ª–µ–≤–æ–º –ø—Ä–∏–∑–Ω–∞–∫–µ –º–µ–∂–¥—É –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –≤ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–∏ ‚âà5:1
# > - **–ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö** –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –∫–∞—á–µ—Å—Ç–≤–æ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –≤—ã—è–≤–∏–ª —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–∞–∑–ª–∏—á–∏—è –≤ –ø–æ–≤–µ–¥–µ–Ω–∏–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∫–ª—é—á–µ–≤—ã–º –ø—Ä–∏–∑–Ω–∞–∫–∞–º
# > - **–ö–æ—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑** –≤—ã—è–≤–∏–ª –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –∏–º–µ—é—Ç –ø—Ä—è–º—É—é –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—é —Å —Ü–µ–ª–µ–≤—ã–º –ø—Ä–∏–∑–Ω–∞–∫–æ–º, –∞ —Ç–∞–∫–∂–µ –º—É–ª—å—Ç–∏–∫–æ–ª–ª–∏–Ω–µ–∞—Ä–Ω–æ—Å—Ç—å –º–µ–∂–¥—É –Ω–µ–∫–æ—Ç–æ—Ä–≤–º–∏–≤—Ö–æ–¥—è—â–∏–º–∏ –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏. –ë—ã–ª–∏ –≤—ã—è–≤–ª–µ–Ω—ã —Å–∞–º—ã–µ —Å–∏–ª—å–Ω–æ –∫–æ—Ä—Ä–µ–ª–∏—Ä—É—é—â–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏:
# >| –ü—Ä–∏–∑–Ω–∞–∫                  | –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è |
# >| ------------------------ | ---- |
# >| contract_duration_days   | 0.37 |
# >
# > - –ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ **–±—ã–ª —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –¥–∞—Ç–∞—Ñ—Ä–µ–π–º –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –æ–±—É—á–µ–Ω–∏—è ML-–º–æ–¥–µ–ª–µ–π**

# ## –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –æ–±—É—á–µ–Ω–∏–µ ML-–º–æ–¥–µ–ª–µ–π
# ---

# ### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è ML-–º–æ–¥–µ–ª–µ–π
# ___

# In[42]:


def train_test_split_with_shape(df, 
                                target, 
                                test_size=TEST_SIZE, 
                                random_state=RANDOM_STATE):
    X = df.drop(target, axis=1)
    y = df[target]
    
    X_train, X_test, y_train, y_test = train_test_split(
        X, y, test_size=test_size, random_state=random_state, stratify=y
    )

    result = pd.DataFrame(
        data={'X_shape': [X_train.shape, X_test.shape],
              'y_shape': [y_train.shape, y_test.shape]},
        index=['Train', 'Test']
    )
    
    display(Markdown(f'### –†–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å –≤—ã–±–æ—Ä–æ–∫ `{df.attrs["name"]}` \n___\n'))
    display(result)
    
    return X_train, X_test, y_train, y_test


# In[43]:


def build_pipeline(model_type,
                   base_model,
                   cat_columns,
                   num_columns,
                   ord_categories='auto',
                   ohe_categories='auto'):
        
    transformers = []
        
    num_pipe = ImpPipeline([
        ('scaler', MinMaxScaler())
    ])

    transformers.append(('num', num_pipe, num_columns))

    if model_type in ['linear']:
        ohe_pipe = ImpPipeline([
            ('ohe', OneHotEncoder(categories=ohe_categories, sparse_output=False, handle_unknown='ignore', drop='first'))
        ])

        transformers.append(('cat_ohe', ohe_pipe, cat_columns))
    elif model_type in ['tree', 'ensemble']:
        ord_pipe = ImpPipeline([
            ('ord', OrdinalEncoder(categories=ord_categories, handle_unknown='use_encoded_value', unknown_value=-1)),
        ])

        transformers.append(('cat_ord', ord_pipe, cat_columns))

    preprocessor = ColumnTransformer(transformers, remainder='passthrough')
    
    return ImpPipeline([
        ('preprocessor', preprocessor),
        ('model', base_model)
    ])


# In[44]:


def construct_param_grid_optuna(model_type, preprocessor_num=None):
    if preprocessor_num is None:
        preprocessor_num = [
            StandardScaler(),
            MinMaxScaler(),
            RobustScaler(),
            PowerTransformer(method='yeo-johnson'), 
            QuantileTransformer(output_distribution='uniform'),
            'passthrough'
        ]
        
    if model_type in ['ensemble', 'tree']:
        return {
            'rfc': {
                'model': CategoricalDistribution([RandomForestClassifier(random_state=RANDOM_STATE, n_jobs=-1, class_weight='balanced')]),
                'model__n_estimators': IntDistribution(32, 256, step=16),
                'model__max_depth': IntDistribution(8, 64),
                'model__min_samples_leaf': IntDistribution(2, 50),
                'model__max_features': CategoricalDistribution(['sqrt', 'log2', 0.8]),
                'model__bootstrap': CategoricalDistribution([True, False]),
            },
            'lgbmc': {
                'model': CategoricalDistribution([LGBMClassifier(random_state=RANDOM_STATE, n_jobs=-1, class_weight='balanced', verbose=-1)]),
                'model__n_estimators': IntDistribution(32, 256, step=16),
                'model__max_depth': IntDistribution(8, 64),
                'model__learning_rate': FloatDistribution(0.01, 0.5, log=True),
                'model__reg_alpha': FloatDistribution(0.001, 2.0, log=True),
                'model__reg_lambda': FloatDistribution(0.001, 2.0, log=True),
                'model__num_leaves': IntDistribution(20, 150),
            },
            'adabc': {
                'model': CategoricalDistribution([AdaBoostClassifier(random_state=RANDOM_STATE)]),
                'model__n_estimators': IntDistribution(32, 256, step=16),
                'model__learning_rate': FloatDistribution(0.01, 0.5, log=True),
            }
        }
    
    if model_type in ['linear']:
        return {
            'rc': {
                'model': CategoricalDistribution([RidgeClassifier(random_state=RANDOM_STATE, class_weight='balanced')]),
                'model__alpha': FloatDistribution(0.1, 100.0, log=True),
                'model__max_iter': IntDistribution(32, 256, step=16),
                'preprocessor__num__scaler': CategoricalDistribution(preprocessor_num),                
            },
            'pac': {
                'model': CategoricalDistribution([PassiveAggressiveClassifier(random_state=RANDOM_STATE, class_weight='balanced')]),
                'model__C': FloatDistribution(0.01, 20.0, log=True),
                'model__fit_intercept': CategoricalDistribution([True, False]),
                'model__max_iter': IntDistribution(32, 256, step=16),
                'preprocessor__num__scaler': CategoricalDistribution(preprocessor_num),
            },
            'svc': {
                'model': CategoricalDistribution([SVC(random_state=RANDOM_STATE, class_weight='balanced')]),
                'model__C': FloatDistribution(0.01, 20.0, log=True),
                'model__kernel': CategoricalDistribution(['linear', 'rbf', 'poly']),
                'model__gamma': CategoricalDistribution(['scale', 'auto', 0.001, 0.1]),
            }
        }
    
    display(Markdown(f'–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–∏–ø–∞ –º–æ–¥–µ–ª–∏: "{model_type}"'))


# In[45]:


def get_searcher(final_pipeline,
                 param_grid,
                 search_method,
                 scoring,
                 cv):
    kwargs = dict(
        estimator=final_pipeline,
        scoring=scoring,
        cv=cv,
        n_jobs=1,
        verbose=-1,
        random_state=RANDOM_STATE
    )

    if search_method == 'randomized':
        return RandomizedSearchCV(param_distributions=param_grid, n_iter=30, **kwargs)

    if search_method == 'optuna':
        return OptunaSearchCV(param_distributions=param_grid, n_trials=20, refit=True, **kwargs)

    if search_method == 'bayes':
        return BayesSearchCV(search_spaces=param_grid, n_iter=30, **kwargs)
    
    if search_method == 'grid':
        return GridSearchCV(param_grid=param_grid, **kwargs)


# ### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏
# ---

# In[46]:


# –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–±–æ—Ä–æ–∫
X_train, X_test, y_train, y_test = train_test_split_with_shape(df_final, TARGET_FEATURE)


# In[47]:


# –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–π–ø–ª–∞–π–Ω–æ–≤
num_columns = list(X_train.select_dtypes(include=[float, int]).columns)
cat_columns = list(X_train.select_dtypes(include=[object, 'category']).columns)

tree_pipe_final = build_pipeline(
    model_type='tree',
    base_model=DummyClassifier(strategy='stratified'),
    cat_columns=cat_columns,
    num_columns=num_columns
)

linear_pipeline_final = build_pipeline(
    model_type='linear',
    base_model=DummyClassifier(strategy='stratified'),
    cat_columns=cat_columns,
    num_columns=num_columns
)


# ### –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
# ---

# In[48]:


# –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π —á–µ—Ä–µ–∑ OptunaSearch
os_full_param_grids = construct_param_grid_optuna('tree') | construct_param_grid_optuna('linear')

os_results_list = []
os_best_model = None
os_best_model_name = None
os_best_cv_score = float('-inf')

for model_key, dist in tqdm(os_full_param_grids.items(), 'OSCV Progress'):
    model_name = dist['model'].choices[0].__class__.__name__

    pipeline = linear_pipeline_final if 'linear' in model_key else tree_pipe_final
        
    cv = StratifiedKFold(n_splits=5, shuffle=True, random_state=RANDOM_STATE)
    
    searcher = get_searcher(
        pipeline,
        dist,
        scoring='roc_auc',
        search_method='optuna',
        cv=cv,
    )
    
    with tqdm(desc=f'{model_name}') as pbar:
        searcher.fit(X_train, y_train)
        trials_done = len(searcher.cv_results_)
        
        pbar.update(trials_done)
        pbar.set_postfix({'Best CV': f'{searcher.best_score_:.4f}'})
    
    cv_score = searcher.best_score_
    
    os_results_list.append({
        'Best Model': f'{searcher.best_estimator_.named_steps.model}',
        'Best CV': f'{cv_score:.4f}',
        'Train Time (sec.)': f'{searcher.refit_time_:.2f}',
        'Pred Time (sec.)': f'{searcher.cv_results_["mean_score_time"][searcher.best_index_]:.2f}',
    })
    
    if cv_score > os_best_cv_score:
        os_best_cv_score = cv_score
        os_best_model = searcher.best_estimator_
        os_best_model_name = searcher.best_estimator_.named_steps.model.__class__.__name__


# In[49]:


# –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π
display(Markdown(f'### –ú–µ—Ç—Ä–∏–∫–∏ –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π `Optuna Search`\n___'))
display(pd.DataFrame(os_results_list))


# In[50]:


# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–æ–¥–µ–ª–µ–π –Ω–∞ –∞–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç—å Dummy
dummy = DummyClassifier(strategy='most_frequent', random_state=RANDOM_STATE)
dummy.fit(X_train, y_train)

y_test_dummy_pred = dummy.predict(X_test)
y_test_dummy_proba = dummy.predict_proba(X_test)[:, 1]

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏ –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
y_test_pred = os_best_model.predict(X_test)
y_test_pred_proba = os_best_model.predict_proba(X_test)[:, 1]

# –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–∞—Å—á–µ—Ç—ã –º–µ—Ç—Ä–∏–∫
main_metrics = {
    'CV': f'{os_best_cv_score:.4f}',
    'ROC-AUC': f'{roc_auc_score(y_test, y_test_pred_proba):.4f}',
    'Accuracy': f'{accuracy_score(y_test, y_test_pred):.4f}',
}

dummy_metrics = {
    'CV': '-',
    'ROC-AUC': f'{roc_auc_score(y_test, y_test_dummy_proba)}',
    'Accuracy': f'{accuracy_score(y_test, y_test_dummy_pred):.4f}',
}

best_model_metrics = pd.DataFrame(
    data=[main_metrics, dummy_metrics],
    index=['Best Model', 'Dummy Baseline']
)

# –í—ã–≤–æ–¥ –º–µ—Ç—Ä–∏–∫
display(Markdown(f'### –ú–µ—Ç—Ä–∏–∫–∏ –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏ `{os_best_model_name}`\n___'))
display(os_best_model.named_steps.model)
display(pd.DataFrame(best_model_metrics).T)


# ### –í—ã–≤–æ–¥—ã
# ---
# **–û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π**
# > - –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π –ø—Ä–æ–≤–æ–¥–∏–ª–æ—Å—å –ø—Ä–∏ –ø–æ–º–æ—â–∏ **OptunaSearch** —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º **–Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–æ–¥–µ–ª–µ–π**:
#     - –î–µ—Ä–µ–≤—å—è –∏ –∞–Ω—Å–∞–º–±–ª–∏:
#         - `RandomForestClassifier`
#         - `LGBMClassifier`
#         - `AdaBoostClassifier`
#     - –õ–∏–Ω–µ–π–Ω—ã–µ:
#         - `RidgeClassifier`
#         - `PassiveAggressiveClassifier`
#         - `SVC`
# >
# > - –ù–∞ –æ—Å–Ω–æ–≤–µ –ª—É—á—à–µ–π –æ—Ü–µ–Ω–∫–∏ CV –±—ã–ª–∞ –æ—Ç–æ–±—Ä–∞–Ω–∞ **–ª—É—á—à–∞—è –º–æ–¥–µ–ª—å `LGBMClassifier`** —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
# > ```python
# >     LGBMClassifier(class_weight='balanced',
# >                    learning_rate=0.11115497459571116,
# >                    max_depth=48,
# >                    n_estimators=256,
# >                    n_jobs=-1,
# >                    num_leaves=21,
# >                    random_state=20226,
# >                    reg_alpha=0.16465834707598878,
# >                    reg_lambda=0.03689323680916021,
# >                    verbose=-1)
# > ```
# > - **–õ—É—á—à–∏–µ –º–µ—Ç—Ä–∏–∫–∏** –º–æ–¥–µ–ª–∏ –ø–æ–ª—É—á–∏–ª–∏—Å—å —Å–ª–µ–¥—É—é—â–∏–º–∏:
# >
# > |           | Best Model Baseline | Dummy Baseline |
# > | --------- | ---------- | -------------- |
# > | CV        | 0.8830     | -              |
# > | ROC-AUC   | 0.9132     | 0.5            |
# > | Accuracy  | 0.8862     | 0.8436         |
# >
# >
# > - –ú–æ–¥–µ–ª—å –ø–æ–∫–∞–∑–∞–ª–∞ —Å–≤–æ—é **–∞–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç—å –ø–æ CV –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è**
# > - **–û—Ü–µ–Ω–∫–∞ –º–æ–¥–µ–ª–∏ –ø–æ Dummy** —Ç–∞–∫–∂–µ –ø–æ–∫–∞–∑–∞–ª–∞ —Å–≤–æ—é –∞–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç—å - **–ª—É—á—à–∞—è –º–æ–¥–µ–ª—å –ø—Ä–µ–≤—ã—Å–∏–ª–∞ —Å–ª—É—á–∞–π–Ω—É—é –Ω–∞ ‚âà80%, –∞ `accuracy` –Ω–∞ ‚âà4 –ø—É–Ω–∫—Ç–∞**
# > - –ü—Ä–∏ —ç—Ç–æ–º **–≥–ª–∞–≤–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞ ROC-AUC** –ø—Ä–µ–≤—ã—Å–∏–ª–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤ 0.85 –Ω–∞ 0.6 –ø—É–Ω–∫—Ç–æ–≤ –∏ **—Å–æ—Å—Ç–∞–≤–∏–ª–∞ 0.92 –ø—É–Ω–∫—Ç–∞**
# > - –ú–µ—Ç—Ä–∏–∫–∞ Accuracy –ø–æ–∫–∞–∑–∞–ª–∞, **—á—Ç–æ –º–æ–¥–µ–ª—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –∫–ª–∞—Å—Å —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é –≤ 88.6%**
# > - –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –º–æ–≥—É—Ç –≥–æ–≤–æ—Ä–∏—Ç—å –æ–± **–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è –∏ –º—É–ª—å—Ç–∏–∫–æ–ª–∏–Ω–µ–∞—Ä–Ω–æ—Å—Ç–∏**
# > - **–î–∞–ª–µ–µ –∞–Ω–∞–ª–∏–∑ –±—É–¥–µ—Ç –ø—Ä–æ–≤–æ–¥–∏—Ç—å—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–æ–¥–µ–ª–∏ `Optuna - LGBMClassifier`**

# ## –ê–Ω–∞–ª–∏–∑ –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏
# ---

# ### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –º–æ–¥–µ–ª–∏
# ___

# In[51]:


def show_cm_roc_curve(y_true, y_pred, y_proba):
    fig, (ax_1, ax_2) = plt.subplots(figsize=FIGSIZE_SINGLE, ncols=2, nrows=1)
    
    sns.heatmap(
        confusion_matrix(y_true, y_pred),
        annot=True,
        cmap=PALETTE_NUMERIC,
        cbar=False,
        linewidths=4,
        square=True,
        fmt='d',
        ax=ax_1
    )

    ax_1.set_ylabel('Actually')
    ax_1.set_xlabel('Predictions')
    ax_1.set_title(f'Confussion Matrix', **FONT_SUBTITLE_KWARGS)

    roc_display = RocCurveDisplay.from_predictions(
        y_true,
        y_proba,
        name=f'{model_name}',
        plot_chance_level=True,
        despine=True,
        color=COLOR_SINGLE_GREY_BASIC,
        ax=ax_2
    )
        
    ax_2.fill_between(
        roc_display.fpr,
        roc_display.tpr,
        alpha=0.2,
        color=COLOR_SINGLE_BASIC
    )

    ax_2.set_xlabel('False Positive Rate (FPR)')
    ax_2.set_ylabel('True Positive Rate (TPR)')
    ax_2.set_title(f'ROC-curve', **FONT_SUBTITLE_KWARGS)
    
    plt.tight_layout()
    plt.show()
    plt.close(fig)


# In[52]:


def show_feature_importance_bar(df, top_n=10, model_name='Model'):
    df['norm_value'] = df.value / df.value.max()
    df = df.sort_values('value', ascending=False).head(top_n)
    
    fig, ax = plt.subplots(figsize=FIGSIZE_SINGLE)
    fig.suptitle(f'{model_name}: {top_n} –Ω–∞–∏–±–æ–ª–µ–µ –≤–ª–∏—è—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤', **FONT_SUBTITLE_KWARGS)

    sns.barplot(
        data=df,
        x='value',
        y='name',
        palette=PALETTE_NUMERIC,
        ax=ax   
    )
    
    ax.set(
        xlabel=X_CAPTION_IMP,
        ylabel=Y_CAPTION_IMP,
    )
    
    for bar in ax.containers:
        ax.bar_label(bar, fmt='%.4f', padding=3)
        
    plt.tight_layout()
    plt.show()
    plt.close(fig)
    
    display(df)


# In[53]:


def show_shap(shap_values, model_name='Model'):
    shap.plots.bar(shap_values, show=False)
    fig = plt.gcf()
    fig.set_size_inches(FIGSIZE_SINGLE)
    fig.suptitle(f'{model_name} SHAP Bar: –°—Ä–µ–¥–Ω—è—è –≤–∞–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–æ–≤', **FONT_TITLE_KWARGS)
    plt.tight_layout()
    plt.show()
    plt.close(fig)
    
    shap.plots.violin(shap_values, show=False) 
    fig = plt.gcf()
    fig.set_size_inches(FIGSIZE_SINGLE)
    fig.suptitle(f'{model_name} SHAP Violin: –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–∫–ª–∞–¥–∞ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤', **FONT_TITLE_KWARGS)
    plt.tight_layout()
    plt.show()
    plt.close(fig)
    
    shap.plots.waterfall(shap_values[50], show=False)
    fig = plt.gcf()
    fig.set_size_inches(FIGSIZE_SINGLE)
    fig.suptitle(f'{model_name} SHAP Waterfall: –í–∫–ª–∞–¥ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ', **FONT_TITLE_KWARGS)
    plt.tight_layout()
    plt.show()
    plt.close(fig)


# ### –ê–Ω–∞–ª–∏–∑ –º–∞—Ç—Ä–∏—Ü—ã –æ—à–∏–±–æ–∫ –∏ ROC-–∫—Ä–∏–≤–æ–π
# ___

# In[54]:


# –í—ã–≤–æ–¥ –º–∞—Ç—Ä–∏—Ü—ã –æ—à–∏–±–æ–∫ –∏ ROC-–∫—Ä–∏–≤–æ–π
show_cm_roc_curve(
    y_test,
    y_test_pred,
    y_test_pred_proba,
)


# ### –ê–Ω–∞–ª–∏–∑ –≤–∞–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
# ___

# In[55]:


# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–º—É—Ç–∞—Ü–∏–æ–Ω–Ω–æ–π –≤–∞–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
best_model = os_best_model.named_steps.model
best_model_preprocessor = os_best_model.named_steps.preprocessor
best_model_feature_names= best_model_preprocessor.get_feature_names_out()

X_train_transformed = best_model_preprocessor.transform(X_train)
X_test_transformed = best_model_preprocessor.transform(X_test)

perm_importance = permutation_importance(
    best_model,
    X_test_transformed,
    y_test,
    scoring='roc_auc',
    n_repeats=10,
    random_state=RANDOM_STATE,
    n_jobs=-1
)

# –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∏ –≤—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
feature_importance = pd.DataFrame({
    'name': best_model_feature_names,
    'value': perm_importance.importances_mean,
})

show_feature_importance_bar(feature_importance, model_name=os_best_model_name)


# In[56]:


# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ SHAP-–∑–Ω–∞—á–µ–Ω–∏–π
data = pd.DataFrame(
    X_test_transformed,
    columns=best_model_feature_names
)

explainer = shap.TreeExplainer(best_model)

shap_values = explainer(data)

show_shap(shap_values, model_name=os_best_model_name)


# ### –í—ã–≤–æ–¥—ã
# ---
# **–ê–Ω–∞–ª–∏–∑ –º–∞—Ç—Ä–∏—Ü—ã –æ—à–∏–±–æ–∫ –∏ ROC-–∫—Ä–∏–≤–æ–π**
# > - –ú–∞—Ç—Ä–∏—Ü–∞ –æ—à–∏–±–æ–∫ –ø–æ–∫–∞–∑–∞–ª–∞ —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –º–æ–¥–µ–ª–∏:
# >    - **TP(256)** - –º–æ–¥–µ–ª—å –≤–µ—Ä–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∞ —É—à–µ–¥—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
# >    - **TN(1352)** - –º–æ–¥–µ–ª—å –≤–µ—Ä–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
# >    - **FP(131)** - –º–æ–¥–µ–ª—å –æ—à–∏–±–ª–∞—Å—å: –Ω–∞–∑–≤–∞–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —É—à–µ–¥—à–∏–º–∏, —Ö–æ—Ç—è –æ–Ω–∏ –∞–∫—Ç–∏–≤–Ω—ã
# >    - **FN(69)** - –º–æ–¥–µ–ª—å –æ—à–∏–±–ª–∞—Å—å: –Ω–∞–∑–≤–∞–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∞–∫—Ç–∏–≤–Ω—ã–º–∏, —Ö–æ—Ç—è –æ–Ω–∏ —É—à–ª–∏ <br> <br>
# > 
# > - –ù–∞ ROC-–∫—Ä–∏–≤–æ–π –≤–∏–¥–Ω–æ, —á—Ç–æ **–º–æ–¥–µ–ª—å –æ–±–ª–∞–¥–∞–µ—Ç —Ö–æ—Ä–æ—à–µ–π —Ä–∞–∑–ª–∏—á–∏—Ç–µ–ª—å–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å—é**. –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å ROC-AUC –º–µ—Ç—Ä–∏–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å–æ —Å–ª—É—á–∞–π–Ω—ã–º —É–≥–∞–¥—ã–≤–∞–Ω–∏–µ–º (–ø—É–Ω–∫—Ç–∏—Ä–Ω–∞—è –ª–∏–Ω–∏–π)
# 
# **–ê–Ω–∞–ª–∏–∑ –≤–∞–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤**
# > - –°–æ–≥–ª–∞—Å–Ω–æ –∞–Ω–∞–ª–∏–∑—É –≤–∞–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤, –ª–∏–¥–µ—Ä–æ–º –æ–∫–∞–∑–∞–ª—Å—è –≤—Å–µ–≥–æ –æ–¥–∏–Ω –ø—Ä–∏–∑–Ω–∞–∫ -  **`'contract_duration_days'`**
# > - –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –æ–∫–∞–∑—ã–≤–∞—é—Ç —Å–æ–≤—Å–µ–º –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ
# 
# **–ê–Ω–∞–ª–∏–∑ SHAP**
# > **–°–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏**
# >
# > –ù–∞–∏–±–æ–ª—å—à–∏–π –≤–∫–ª–∞–¥ –≤ –º–æ–¥–µ–ª—å —Ç–∞–∫–∂–µ –ø—Ä–∏–≤–Ω–æ—Å–∏—Ç –ø—Ä–∏–∑–Ω–∞–∫ **`'contract_duration_days'`**
# >
# > **–•–∞—Ä–∞–∫—Ç–µ—Ä –≤–ª–∏—è–Ω–∏—è**
# >
# > - –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤—ã–≤–æ–¥, —á—Ç–æ —á–µ–º –¥–æ–ª—å—à–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–µ—Ç—Å—è –∫–ª–∏–µ–Ω—Ç–æ–º –∫–æ–º–ø–∞–Ω–∏–∏ —Ç–µ–º –º–µ–Ω—å—à–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –µ–≥–æ —É—Ö–æ–¥–∞, —Ä–∞–≤–Ω–æ–∑–Ω–∞—á–Ω–æ –∏ –æ–±—Ä–∞—Ç–Ω–æ–µ - —á–µ–º –º–µ–Ω—å—à–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –∫–æ–º–ø–∞–Ω–∏–µ–π, —Ç–µ–º –≤—ã—à–µ —à–∞–Ω—Å –µ–≥–æ —É—Ö–æ–¥–∞. –•–æ—Ç—è –∏ —Ç–æ—á–∫–∏ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ —Å–∏–ª—å–Ω–æ –ø–µ—Ä–µ–º–µ—à–∞–Ω—ã —Å–ø—Ä–∞–≤–∞, —Å–∫–æ–ø–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –Ω–∏–∑–∫–æ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –±–æ–ª—å—à–µ. –≠—Ç–æ –º–æ–∂–µ—Ç –≥–æ–≤–æ—Ä–∏—Ç—å –æ –≤—ã—Å–æ–∫–æ–π –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ "—Å—Ç–∞—Ä–∏—á–∫–æ–≤"
# > - –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –µ–∂–µ–º–µ—Å—è—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π –≤–∏–¥–Ω–æ, —á—Ç–æ –±–æ–ª—å—à–∞—è —Å—É–º–º–∞ –µ–∂–µ–º–µ—Å—è—á–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —É—Ö–æ–¥–∞, –∞ –º–µ–Ω—å—à–∞—è - —É–º–µ–Ω—å—à–∞–µ—Ç —à–∞–Ω—Å—ã.
# > - –ù–∞–ª–∏—á–∏–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–Ω—ã–º –æ–±—Ä–∞–∑–æ–º –æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —É—Ö–æ–¥–∞. –í–µ—Ä–æ—è—Ç–Ω–æ, –¥–ª—è —Ç–∞–∫–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤–∞–∂–Ω–æ –Ω–∞–ª–∏—á–∏–µ —Å–µ–º–µ–π–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞
# > - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ —Ç–∞–∫–∂–µ –æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∏–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —É—Ö–æ–¥–∞. –í–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ —Å—Ç–æ–∏—Ç —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –≤ —Å–≤—è–∑–∫–µ —Å –µ–∂–µ–º–µ—Å—è—á–Ω—ã–º–∏ –ø–ª–∞—Ç–µ–∂–∞–º–∏, —Ç.–∫. –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Ä–≤–∏—Å–æ–≤ –ª–æ–≥–∏—á–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–∞—Ä–∏—Ñ–∞
# > - –¢–æ –∂–µ —Å–∞–º–æ–µ –º–æ–∂–µ—Ç –∏ –∫–∞—Å–∞—Ç—å—Å—è –∫–æ–ª-–≤–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –ª–∏–Ω–∏–π. –ë–æ–ª—å—à–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ª–∏–Ω–∏–π - –±–æ–ª—å—à–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–∞—Ä–∏—Ñ–∞
# > - –ú–µ—Ç–æ–¥ –ø–ª–∞—Ç–µ–∂–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–∏–∫–∞–∫ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —É—Ö–æ–¥–∞, –Ω–æ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏ –º–æ–≥—É—Ç —Ç–∞–∫ –∏–ª–∏ –∏–Ω–∞—á–µ –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ –Ω–µ–µ
# >
# > **–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø—Ä–∏–∑–Ω–∞–∫**
# >
# > –°–æ–≥–ª–∞—Å–Ω–æ –æ–¥–Ω–æ–º—É –ø—Ä–∏–∑–Ω–∞–∫—É –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å, –∫–∞–∫ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∞–ª–∏—è–ª –ø—Ä–∏–∑–Ω–∞–∫ –º–µ—Å—è—á–Ω—ã—Ö —Ç—Ä–∞—Ç –≤ —Ç–æ—Ç–∞–ª–µ –Ω–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ. –î–∞–ª–µ–µ –∏–¥–µ—Ç –Ω–∞–ª–∏—á–∏–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞, –∫–æ–ª-–≤–æ –ø–æ–¥–∫–ª—á–µ–Ω–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤, –º–µ—Ç–æ–¥ –ø–ª–∞—Ç–µ–∂–∞ –∏ –∫–æ–ª-–≤–æ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –ª–∏–Ω–∏–π. –í–∏–¥–Ω–æ, —á—Ç–æ –∫–∞–∂–¥—ã–π –∏–∑ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ —Å–¥–µ–ª–∞–ª –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –≤ –ø–æ–ª—å–∑—É —É—Ö–æ–¥–∞ –¥–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
# >
# > –û–¥–Ω–∞–∫–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–∫–∞–∑–∞–ª–∞ –Ω–∏–º–µ–Ω—å—à–µ–µ –≤–ª–∏—è–Ω–∏–µ.

# ## –ò—Ç–æ–≥–æ–≤—ã–µ –≤—ã–≤–æ–¥—ã
# ---

# ### –ö—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä –ø—Ä–æ–¥–µ–ª–∞–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã
# ___
# > - –î–∞–Ω–Ω—ã–µ –±—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–µ–Ω—ã
# >
# >
# > - –ü—Ä–æ–≤–µ–¥–µ–Ω–∞ –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –∫–æ—Ç–æ—Ä–æ–π –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã, –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ø—Ä–æ–ø—É—Å–∫–∏ –∏ –Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã –∞–Ω–æ–º–∞–ª–∏–∏ –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º —É–¥–∞–ª–µ–Ω–∏—è, —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ. –¢–∞–∫–∂–µ –Ω–∞ —Å–æ–Ω–æ–≤–µ –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –±—ã–ª —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω —Ü–µ–ª–µ–≤–æ–π –ø—Ä–∏–∑–Ω–∞–∫
# >
# >
# > - –ü—Ä–æ–≤–µ–¥–µ–Ω –æ–±—â–∏–π –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–π —Ç–∞–∫–∂–µ –≤–∫–ª—é—á–∞–ª –≤ —Å–µ–±—è –∫–æ—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑, –∞–Ω–∞–ª–∏–∑ –¥–∏—Å–±–∞–ª–∞–Ω—Å–∞ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö. –ù–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –±—ã–ª–∏—è –≤—ã—è–≤–ª–µ–Ω—ã –º—É–ª—å—Ç–∏–∫–æ–ª–ª–∏–Ω–µ–∞—Ä–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –∏ –ø—Ä–∏–∑–Ω–∞–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥–ª–∏ –±—ã –ø–æ–≤–ª—è—Ç—å –Ω–∞ —É—Ç–µ—á–∫—É –¥–∞–Ω–Ω—ã—Ö, –ø–æ—Å–ª–µ —á–µ–≥–æ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã.
# >
# >
# > - –ë—ã–ª–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–∞ –∏ –≤—ã–±—Ä–∞–Ω–∞ **–ª—É—á—à–∞—è ML-–º–æ–¥–µ–ª—å –¥–ª—è –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –æ—Ç—Ç–æ–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**. –î–ª—è –ø–æ–∏—Å–∫–∞ –º–æ–¥–µ–ª–∏ –±—ã–ª –≤—ã–±—Ä–∞–Ω —Å–ø–æ—Å–æ–± Optuna Search. –í –∫–∞—á–µ—Å—Ç–≤–µ –ª—É—á—à–µ–π –º–æ–¥–µ–ª–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ü–µ–Ω–∫–∏ CV –∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ –æ–±—É—á–µ–Ω–∏—è –±—ã–ª–∞ –≤—ã–±—Ä–∞–Ω–∞ –º–æ–¥–µ–ª—å —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
# > ```python
# >     LGBMClassifier(class_weight='balanced',
# >                    learning_rate=0.11115497459571116,
# >                    max_depth=48,
# >                    n_estimators=256,
# >                    n_jobs=-1,
# >                    num_leaves=21,
# >                    random_state=20226,
# >                    reg_alpha=0.16465834707598878,
# >                    reg_lambda=0.03689323680916021)
# > ```
# >
# > - –ü—Ä–æ–≤–µ–¥–µ–Ω—ã –∞–Ω–∞–ª–∏–∑ –º–∞—Ç—Ä–∏—Ü—ã –æ—à–∏–±–æ–∫ –∏ ROC-–∫—Ä–∏–≤–æ–π, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∞–∑–∞–ª–∏ —Ö–æ—Ä–æ—à—É—é —Ä–∞–∑–ª–∏—á–∏—Ç–µ–ª—å–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ –∏ –µ–µ –æ–±—â—É—é —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ –∞–¥–µ–∫–≤–∞—Ç–Ω–æ—Å—Ç—å
# >
# > - –ü—Ä–æ–≤–µ–¥–µ–Ω –∞–Ω–∞–ª–∏–∑ –≤–∞–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∫–∞–∑–∞–ª, —á—Ç–æ –Ω–∞–∏–±–æ–ª–µ–µ –≤–ª–∏—è—Ç–µ–ª—å–Ω—ã–º –∏–∑ –Ω–∏—Ö —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏–∑–Ω–∞–∫ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ - **`'contract_duration_days'`**
# >
# >
# > - –ê–Ω–∞–ª–∏–∑ –ø—Ä–∏ –ø–æ–º–æ—â–∏ –º–µ—Ç–æ–¥–∞ SHAP —Ç–∞–∫–∂–µ –ø–æ–∫–∞–∑–∞–ª, —á—Ç–æ –¥–∞–Ω–Ω—ã–π –ø—Ä–∏–∑–Ω–∞–∫ —è–≤–ª—è–µ—Ç—Å—è –Ω–∞–∏–±–æ–ª–µ–µ –≤–ª–∏—è—Ç–µ–ª—å–Ω—ã–º–∏ –≤ –∫–∞–∂–¥–æ–º –∏–∑ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π

# ### –ì–ª–∞–≤–Ω—ã–π –≤—ã–≤–æ–¥ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
# ___
# **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
# > –ú–æ–¥–µ–ª—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –ø–æ–∫–∞–∑–∞–ª–∞, —á—Ç–æ –Ω–∞–∏–±–æ–ª—å—à–µ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –æ—Ç—Ç–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞
# >
# >
# > –ò—Å—Ö–æ–¥—è –∏–∑ —ç—Ç–æ–≥–æ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∏–¥–µ—é, –∫–∞–∫ –∏ –±—ã–ª–æ –∑–∞–¥—É–º–∞–Ω–æ —Ä–∞–Ω–µ–µ —Å–∞–º–æ–π –∫–æ–º–ø–∞–Ω–∏–µ–π, –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥—ã –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –≤—Å–µ–º, –∫—Ç–æ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç —É—Å–ª—É–≥ —Å–≤—è–∑–∏. –ù–æ –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å —Å—Ç–æ–∏—Ç —Å–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö, —Ç.–∫. –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∏—Ö —É—Ö–æ–¥–∞ –æ–∫–∞–∑–∞–ª–∞—Å—å –≤—ã—à–µ, –Ω–µ–∂–µ–ª–∏ —É –ª–æ—è–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
# >
# > –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è —É–¥–µ—Ä–∂–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏—Å—Ö–æ–¥—è –∏–∑ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –º–æ–∂–Ω–æ –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–µ–µ:
# > - –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–∞–∫–µ—Ç–Ω—ã—Ö —Ç–∞—Ä–∏—Ñ–æ–≤ –∏/–∏–ª–∏ —Ç–∞—Ä–∏—Ñ–æ–≤-–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç—è—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Å—Ä–∞–∑—É –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Å–ª—É–≥ –∏/–∏–ª–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
# > - –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–µ–º–µ–π–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞ –¥–ª—è –ª—é–¥–µ–π —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä
# > - –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–∞ —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º —Å–Ω–∏–∂–µ–Ω–∏–µ–º —Ü–µ–Ω—ã –∫–∞–∂–¥—ã–π –≥–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–æ –ø—Ä–∏–µ–º–ª–µ–º–æ–≥–æ –ø–æ—Ä–æ–≥–∞ –ø–æ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏
# > - –î–µ–ª–∞—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ —Å–µ–∑–æ–Ω–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ –∞–∫—Ü–∏–∏ –¥–ª—è —Ç–µ–∫—É—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–æ–ø–ª–∞—Ç–∏ 3 –º–µ—Å—è—Ü–∞ –∏ –ø–æ–ª—É—á–∏ 4-–π –≤ –ø–æ–¥–∞—Ä–æ–∫"
# > - –ü—Ä–µ–¥–ª–∞–≥–∞—Ç—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ü–µ–Ω—ã —Å–æ–ø–æ—Å—Ç–∞–≤–∏–º—ã–µ —Å —Ç–µ–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –∏–º –ø—Ä–µ–¥–ª–æ–∂–∏–ª–∏ –¥—Ä—É–≥–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å
# > - –ü—Ä–æ–≤–µ—Å—Ç–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∏ –≤ —Ü–µ–ª–æ–º –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è, —Ç.–∫. –µ—Å—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å, —á—Ç–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –º–æ–≥—É—Ç –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –±–æ–ª–µ–µ –≤—ã–≥–æ–¥–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è

# ### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—é –±–∞–∑—ã
# ___
# > –í –æ–±—â–µ–º –≤–∏–¥–µ –¥–∞—Ç–∞—Ñ—Ä–µ–π–º –æ–∫–∞–∑–∞–ª—Å—è –Ω–µ –æ—á–µ–Ω—å —á–∏—Å—Ç—ã–º, –≤ —Å–≤—è–∑–∏ —Å —á–µ–º –º–æ–∂–Ω–æ –¥–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
# > - –°—Ä–∞–∑—É –∑–∞–¥–∞–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –±–∞–∑—ã
# > - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–ø–æ–ª–Ω—è—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –±–∞–∑–∞—Ö –ø—Ä–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∏—é —ç—Ç–æ –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã —Å–¥–µ–ª–∞—Ç—å –∑–∞—Ä–∞–Ω–µ–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –∏–º–∏ –∏ –Ω–µ –ø–æ–ª—å–∑—É—é—Ç—Å—è)
# > - –í –ø–æ–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞, –µ—Å–ª–∏ –æ–Ω –µ—â–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω, –∞–≤—Ç–æ–º–∞—Ç–∏–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è—Ç—å —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
# > - –í –¥–∞–ª—å–Ω–µ–π—à–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å:
#     - –≤–µ—Ä–Ω—É–≤—à–∏–π—Å—è –ª–∏ —ç—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 
#     - –ø—Ä–∏—á–∏–Ω–∞ –ø–æ –∫–æ—Ç–æ—Ä–æ–π –≤–µ—Ä–Ω—É–ª—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: –∞–∫—Ü–∏—è, –ø—Ä–æ–º–æ–∫–æ–¥, —Å–∫–∏–¥–∫–∞, –Ω–æ–≤—ã–π —Ç–∞—Ä–∏—Ñ –∏ —Ç.–¥)

# In[ ]:


get_ipython().system('pip3 install pipreqs -q')
get_ipython().system('pipreqs . --print')
get_ipython().system('jupyter nbconvert --to python *.ipynb')
get_ipython().system('pipreqs')
get_ipython().system('pipreqs . --force')

